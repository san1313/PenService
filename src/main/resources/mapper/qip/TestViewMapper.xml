<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pen.app.qip.mapper.TestViewMapper">
	<select id="getMatView" resultType="TestViewVO">
	SELECT qip_code_list_mat,
		   mat_ordernum,
	       mat_name,
	       to_char(test_date, 'YYYY-MM-DD') AS test_date,
	       emp_name,
	       test_num_mat,
	       test_tnum_def,
	       test_tnum_pass
	FROM qip_list_mat
	JOIN mat_order USING ( mat_dtaordcode )
	JOIN com_info_emp USING ( emp_num )
	<where>
	<if test='itemName != null and itemName != ""'>
	AND MAT_NAME LIKE '%'||#{itemName}||'%'
	</if>
	<if test='startDate != null and startDate != ""'>
	AND TEST_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD') 
	</if>
	</where>
	ORDER BY qip_code_list_mat DESC
	</select>
	
	<select id="getItemView" resultType="TestViewVO">
	SELECT *
	FROM ( SELECT qip_code_list_prod,
	              a.indica_code,
	              ( SELECT prod_name
	                FROM com_code_prod
	                WHERE prod_code = b.prod_code
	              ) AS prod_name,
	              ( SELECT proc_name
	                FROM com_proc_flow
	                JOIN com_code_proc USING ( proc_code )
	                WHERE flow_prod_code = b.prod_code
	                      AND proc_order = a.proc_order
	              ) AS proc_name,
	              to_char(test_date, 'YYYY-MM-DD') AS test_date,
	              ( SELECT emp_name
	                FROM com_info_emp
	                WHERE emp_num = a.emp_num
	              ) AS emp_name,
	              test_num_prod,
	              test_tnum_pass,
	              test_tnum_def
	       FROM qip_list_prod a
	       JOIN mak_indica b ON ( a.indica_code = b.indica_code )
	     )
	<where>
	<if test='itemName != null and itemName != ""'>
	AND PROD_NAME LIKE '%'||#{itemName}||'%'
	</if>
	<if test='startDate != null and startDate != "" and endDate != null and endDate != ""'>
	AND TEST_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD') 
	</if>
	</where>
	ORDER BY qip_code_list_prod DESC
	</select>
</mapper>