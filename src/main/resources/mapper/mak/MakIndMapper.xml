<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pen.app.mak.mapper.MakIndMapper">
<!-- 주문서 기반 계획서[미지시건] 불러오기(모달) -->
<select id="ordPlanning" resultType="PlanVO" parameterType="MakVO">
	select ord_code,ord_det_code,pd_code,plan_code,plan_nm||'-'||prod_name planNm,plan_type,to_char(plan_date,'yyyy-MM-dd') planDate, mak_emp_num,plan_state,pd_prod_code,plan_qnt,plan_qnt re_qnt,to_char(plan_sdate,'yyyy-MM-dd') planSdate, to_char(plan_clsdate,'yyyy-MM-dd') planClsdate, priority, connect_code,prod_code,prod_name,ord_det_price,ord_det_quan,acc_code,acc_name,ord_date,ord_due_date from ordplan_view
	<where>
	<foreach collection="list" item="ordPlan" separator=" and ">
	pd_code != #{ordPlan.pdCode}
	</foreach>
	</where>
	order by ord_due_date
</select>
<!-- 주문서 기반 계획서[지시건] 불러오기(모달) -->
<select id="ordPlanned" resultType="PlanVO" parameterType="MakVO">
	select ord_code,
           ord_det_code,
           pd_code,
           plan_code,
           plan_nm||'-'||prod_name planNm,
           plan_type,
           to_char(plan_date,'yyyy-MM-dd') planDate, 
           mak_emp_num,
           plan_state,
           pd_prod_code,
           plan_qnt,
           plan_qnt - #{reQnt} re_qnt,
           to_char(plan_sdate,'yyyy-MM-dd') planSdate, 
           to_char(plan_clsdate,'yyyy-MM-dd') planClsdate, 
           priority, 
           connect_code,
           prod_code,
           prod_name,
           ord_det_price,
           ord_det_quan,
           acc_code,
           acc_name,
           ord_date,
           ord_due_date from ordplan_view
	<where>
	pd_code = #{pdCode}
	</where>
</select>

<!-- 주문서기반 계획서에서 내린 계획서별 지시건별 총 지시 수량 -->
<select id="getOrdReQnt" resultType="MakVO">
select pd_code,sum(ordr_qnt) re_qnt from mak_indica join ordplan_view using(pd_code) group by pd_code
</select>

<select id="getConReQnt" resultType="MakVO">
select pd_code,sum(ordr_qnt) re_qnt from mak_indica join conplan_view using(pd_code) group by pd_code
</select>

<select id="getIndReQnt" resultType="MakVO">
select pd_code, plan_qnt-sum(ordr_qnt) re_qnt  from mak_plan_detail join mak_indica using(pd_code) group by pd_code, plan_qnt
</select>
<!-- 계약서 기반 계획서 불러오기(모달) -->
<select id="contPlanning" resultType="PlanVO" parameterType="MakVO">
	select cont_code,cont_det_code,pd_code,plan_code,plan_nm||'-'||prod_name planNm,plan_type,to_char(plan_date,'yyyy-mm-dd') planDate,mak_emp_num,plan_state,pd_prod_code,plan_qnt,plan_qnt re_qnt,to_char(plan_sdate,'yyyy-mm-dd') planSdate, to_char(plan_clsdate,'yyyy-mm-dd') planClsdate, priority, connect_code,prod_code,prod_name,cont_det_quan,cont_det_release,cont_det_progress,acc_code,acc_name,to_char(cont_date,'yyyy-mm-dd') contDate,to_char(cont_due_date,'yyyy-MM-dd') contDueDate from conplan_view
		<where>
	<foreach collection="list" item="ordPlan" separator=" and ">
	pd_code != #{ordPlan.pdCode}
	</foreach>
	</where>
	order by cont_det_release
</select>

<select id="contPlanned" resultType="PlanVO" parameterType="MakVO">
	select cont_code,cont_det_code,pd_code,plan_code,plan_nm||'-'||prod_name planNm,plan_type,to_char(plan_date,'yyyy-mm-dd') planDate,mak_emp_num,plan_state,pd_prod_code,plan_qnt,plan_qnt-#{reQnt} re_qnt,to_char(plan_sdate,'yyyy-mm-dd') planSdate, to_char(plan_clsdate,'yyyy-mm-dd') planClsdate, priority, connect_code,prod_code,prod_name,cont_det_quan,cont_det_release,cont_det_progress,acc_code,acc_name,to_char(cont_date,'yyyy-mm-dd') contDate,to_char(cont_due_date,'yyyy-MM-dd') contDueDate from conplan_view
		<where>
	pd_code = #{pdCode}
	</where>
</select>


<select id="indList" resultType="MakVO" parameterType="string">
	select prod_name,pd_code,plan_code,plan_nm,plan_type,mak_emp_num,plan_state,pd_prod_code,plan_qnt,to_char(plan_sdate,'yyyy-mm-dd') plan_sdate, to_char(plan_clsdate,'yyyy-mm-dd') plan_clsdate,priority,indica_code,indica_nm,emp_num,prod_code,ordr_qnt,to_char(indica_date,'yyyy-mm-dd') indica_date, to_char(st_date,'yyyy-mm-dd') st_date,to_char(cls_date,'yyyy-mm-dd') cls_date, indica_state from mak_plan join mak_plan_detail using(plan_code) join mak_indica using(pd_code) join com_code_prod using(prod_code) where pd_code = #{pdCode} and cls_date>=to_date(sysdate,'yyyy-mm-dd') and indica_state in ('미작업','작업중')
</select>

<select id="planFlow" parameterType="string" resultType="MakVO">
	select * 
		from com_proc_flow a join com_code_proc b using(proc_code)
			right outer join (
				select * 
					from(SELECT 
				    	LEVEL LEV,
				    	PARENT_CODE,
				    	BOM_MAT_TYPE,
				    	BOM_PROD_CODE,
				    	BOM_PROD_NAME,
				    	BOM_MAT_UNIT,
				    	BOM_MAT_USAGE,
				    	PROC_CODE
						FROM (SELECT  
							B.BOM_PROD_CODE AS PARENT_CODE,
							BOM_MAT_TYPE,
							A.BOM_PROD_CODE,
							A.BOM_PROD_NAME,
							BOM_MAT_UNIT,
							BOM_MAT_USAGE,
							PROC_CODE
							FROM (SELECT
								BOM_PROD_CODE,
								BOM_PROD_NAME
								FROM (SELECT
									BOM_PROD_CODE,
									BOM_PROD_NAME,
									BOM_MAT_CODE,
									BOM_MAT_NAME 
									FROM COM_BOM
									WHERE 
										BOM_PROD_CODE = #{prodCode}
										OR BOM_PROD_CODE IN (SELECT BOM_MAT_CODE FROM COM_BOM WHERE BOM_PROD_CODE = #{prodCode}))
											UNION
												SELECT BOM_MAT_CODE, 
												BOM_MAT_NAME
												FROM (SELECT 
													BOM_PROD_CODE, 
													BOM_PROD_NAME, 
													BOM_MAT_CODE, 
													BOM_MAT_NAME 
													FROM COM_BOM
													WHERE BOM_PROD_CODE = #{prodCode} 
														OR BOM_PROD_CODE IN (SELECT BOM_MAT_CODE FROM COM_BOM WHERE BOM_PROD_CODE = #{prodCode}))) A 
															LEFT OUTER JOIN COM_BOM B ON (A.BOM_PROD_CODE = B.BOM_MAT_CODE))
																START WITH PARENT_CODE IS NULL
																CONNECT BY PARENT_CODE = PRIOR BOM_PROD_CODE)) using(proc_code) order by lev desc
</select>

<select id="getIndicatedBom" resultType="MakVO" parameterType="string">
select a.mak_bom_code,a.mak_flow_code,a.mak_step,a.prod_code,a.amount,a.plan_indica,b.proc_code,c.bom_code,c.bom_prod_code parent_code,c.bom_prod_name prod_name,c.bom_mat_type,c.bom_mat_name bom_prod_name,c.bom_mat_code bom_prod_code,c.bom_mat_usage,d.proc_type,d.proc_name from mak_bom a join mak_flow b on a.mak_flow_code = b.mak_flow_code join com_bom  c on b.proc_code=c.proc_code and a.prod_code = c.bom_mat_code join com_code_proc d on b.proc_code =d.proc_code  where plan_indica = #{indicaCode} order by mak_step
</select>

<select id="getOperateCheck" parameterType="MakVO" resultType="MakVO" >
	select fac_name,fac_code,operate_check,proc_code,proc_name from fac_info join fac_conn_proc using(fac_code) join com_code_proc using(proc_code) where proc_code in (
	<foreach collection="list" item="pc" separator="," close=")">
		#{pc.procCode}
	</foreach>
	order by fac_code
</select>


<select id="getFlowList" parameterType="MakVO" resultType="MakVO">
	select proc_order + (select max(proc_order) from com_proc_flow where flow_prod_code like('SE%') and flow_prod_code in (
	<foreach collection="list" item="pc" separator="," close=")">
		#{pc.parentCode}
	</foreach>
	) proc_order,
	proc_flow_code,
	proc_code,
	flow_prod_code,
	proc_type,
	proc_name 
	    from com_proc_flow join com_code_proc using(proc_code) 
	            where flow_prod_code like ('PR%')
						and flow_prod_code in (
							<foreach collection="list" item="pc" separator="," close=")">
								#{pc.parentCode}
							</foreach>
								union
									select proc_order,
									       proc_flow_code,
									       proc_code,
									       flow_prod_code,
									       proc_type,
									       proc_name
									          from com_proc_flow join com_code_proc using(proc_code)
									                   where flow_prod_code like('SE%') and flow_prod_code in (
															<foreach collection="list" item="pc" separator="," close=")">
																#{pc.parentCode}
															</foreach>
															order by proc_order
														</select>
<!-- 
<select id="getFlowList" parameterType="MakVO" resultType="MakVO">
	
	select * from com_proc_flow a join com_code_proc b using(proc_code) where flow_prod_code in (
	<foreach collection="list" item="pc" separator="," close=")">
		#{pc.parentCode}
	</foreach>
	order by proc_order
</select> -->

<update id="insertIndica" parameterType="MakVO">
	insert into mak_indica(indica_code,
						   indica_nm,
						   emp_num,
						   prod_code,
						   ordr_qnt,
						   indica_date,
						   st_date,
						   cls_date,
						   pd_code) values
						             (get_indica_seq(),
						             #{indicaNm},
						             '1111',
						             #{prodCode},
						             #{ordrQnt},
						             to_date(#{indicaDate},'yyyy-mm-dd'),
						             to_date(#{stDate},'yyyy-mm-dd'),
						             to_date(#{clsDate},'yyyy-mm-dd'),
						             #{pdCode})
</update>

<update id="insertBOM">
insert into mak_bom(mak_bom_code,
                    mak_step,
                    prod_code,
                    amount,
                    plan_indica,
                    mak_flow_code) values(
                                        mak_bom_seq.nextval,
                                        #{makStep},
                                        #{bomProdCode},
                                        #{amount},
                                        'MAK-IND-'||(select last_number-1 from user_sequences where sequence_name='MAK_INDICA_SEQ'),
                                        #{makFlowCode}
                                        )
</update>

<update id="insertFlow">
insert into mak_flow(mak_flow_code,
                     mak_flow_step,
                     proc_code
                     ) values(
                                          mak_flow_seq.nextval,
                                          #{makFlowStep},
                                          #{procCode}
                                          )
</update>

<select id="getFlowSeq" resultType="integer">
select mak_flow_seq.currval from dual
</select>

<select id="getCurrBom" resultType="MakVO">
select prod_code,sum(amount) amount from mak_bom where plan_indica='MAK-IND-'||(select last_number-1 from user_sequences where sequence_name='MAK_INDICA_SEQ') and prod_code like 'MA%' group by prod_code
</select>

<select id="getMatQnt" resultType="MakVO" parameterType="string">
select mat_lot,mat_code,mat_name,mat_qnt,mat_state from mat_invntry where mat_code=#{prodCode} and mat_qnt>0 and NVL(mat_keepdate,sysdate+1)>=to_date(sysdate,'yyyy-mm-dd') order by mat_lot
</select>

<update id="insertHold" parameterType="MakVO">
insert into mak_hold(rsc_code,indica_code,mat_code,mat_lot,cnt,hold_date) values(get_hold_seq(),'MAK-IND-'||(select last_number-1 from user_sequences where sequence_name='MAK_INDICA_SEQ'),#{matCode},#{matLot},#{cnt},sysdate)
</update>
<update id="updateMat" parameterType="MakVO">
update mat_invntry set mat_qnt=mat_qnt-#{cnt} where mat_lot = #{matLot} 
</update>

<update id="updateIndica" parameterType="MakVO">
update mak_indica set ORDR_QNT = #{ordrQnt}, st_date=#{stDate}, cls_date=#{clsDate} where indica_code = #{indicaCode}
</update>

<update id="updateMakBom" parameterType="MakVO">
update mak_bom set amount = #{amount} where mak_bom_code = #{makBomCode}
</update>

<select id="getIndMakHold" parameterType="string" resultType="MakVO">
select rsc_code,mat_code,mat_lot,cnt from mak_hold where indica_code=#{indicaCode}
</select>

<update id="updateIndMakHold" parameterType="MakVO">
update mak_hold set cnt = cnt - #{cnt} where rsc_code = #{rscCode}
</update>

<update id="updateIndMakMat" parameterType="MakVO">
update mat_invntry set mat_qnt=mat_qnt + #{cnt} where mat_lot=#{matLot}
</update>

<delete id="delIndica" parameterType="MakVO">
delete mak_indica where indica_code=#{indicaCode}
</delete>
<delete id="delIndBom" parameterType="integer">
delete mak_bom where mak_bom_code=#{makBomCode}
</delete>

<delete id="delIndFlow" parameterType="integer">
delete mak_flow where mak_flow_code=#{makFlowCode}
</delete>

<delete id="delIndHold" parameterType="string">
delete mak_hold where indica_code=#{indicaCode}
</delete>

<select id="dirIndList" resultType="MakVO">
select prod_name,indica_code,indica_nm,emp_num,prod_code,ordr_qnt,to_char(indica_date,'yyyy-mm-dd') indica_date, to_char(st_date,'yyyy-mm-dd') st_date,to_char(cls_date,'yyyy-mm-dd') cls_date, indica_state from mak_indica join com_code_prod using(prod_code) where pd_code is null and cls_date>=to_date(sysdate,'yyyy-mm-dd') and indica_state in ('미작업','작업중')
</select>

<select id="product" resultType="MakVO">
select * from com_code_prod
</select>
 <!-- 사원 리스트 출력 -->
  <!-- <select id="getUserList" resultType="UserVO">
  	SELECT * FROM COM_INFO_EMP JOIN COM_CODE_AUTH USING(AUTH_CODE) ORDER BY EMP_NUM
  </select> -->
</mapper>