<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{layout/template}">
<head>
<meta charset="UTF-8" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
<title>PenServiceMES</title>
<style>

</style>

 <script src="https://code.jquery.com/jquery-1.11.3.js"></script>
<link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css">
<script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
</head>

<body>
<div layout:fragment="title">설비점검관리</div>

<!-- 메인콘텐츠 -->
   <div layout:fragment="content">
   
<div class="fac_confirm" style="text-align:left">
   <div class = "col-12 fac_confirm">
            <label for="confirm_code" hidden>점검코드&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="text"id="confirm_code" placeholder="CONFIRM" readonly>&nbsp;&nbsp;&nbsp;&nbsp;
            </label>
            
            <label for="confirm_date">점검일시</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="date">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            
            <label for="fac_code">설비코드&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="text"id="fac_code">
            <button type="button" id="facSelectmodalbtn" class="btn btn-primary" data-toggle="modal" data-target=".bd-smallproduct-modal-sm"><i class="fa fa-search"></i></button>
                
            <label for="fac_name">설비명&nbsp;&nbsp;&nbsp;
            <input type="text" id="fac_name">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </label> 
                       
            <label for="confirm_category" id="confirm_category">점검구분&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="radio" name="regular_confirm" value="정기점검" checked> 정기점검&nbsp;&nbsp;&nbsp;
            <input type="radio" name="occasional_confirm" value="수시점검"> 수시점검&nbsp;&nbsp;&nbsp;
            <input type="radio" name="emergency_confirm" value="긴급점검"> 긴급점검&nbsp;&nbsp;&nbsp;
            
            <br>
            <label for="action_history">조치내역</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="text" id="action_history">&nbsp;&nbsp;&nbsp;&nbsp;
              
            <label for="confirm_issue">점검사항</label>&nbsp;&nbsp;
            <select name="confirm_issue" style="width:190px; height:30px;" >
               <option value="선택" selected="selected">----------사항선택----------</option>
               <option value="점검">점검</option>
               <option value="고장">고장</option>
            </select>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                   
            <label for="emp_num">담당자&nbsp;&nbsp;&nbsp;
            <input type="text" id="emp_num">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </label>
            
            <label for ="decision">판정&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="radio" name="fit" value="적합" checked>&nbsp;&nbsp;적합&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="radio" name="unfit" value="부적합">&nbsp;&nbsp;부적합 
           	
            <br><br>
            
            <div class="col-12">
               <div class="col-8" style="margin:0 auto">
                  <button class="w-30 btn btn-primary btn-lg" id="register" type="submit">등록</button>
                  <button class="w-30 btn btn-warning btn-lg" id="update" type="button">수정</button>
                  <button class="w-20 btn btn-danger btn-lg" id="delete" type="button">삭제</button>
                  <button class="w-30 btn btn-success btn-lg" id="reset" type="reset">초기화</button>
               </div>
            </div>
   </div>
   
</div>

<!--설비조회 모달-->
<div class="modal fade bd-example-modal-lg" id="chfacmodalbtn" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
            <h5 class="modal-title" >설비코드조회</h5>
         <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>   
      </div>
      
      <div class="modal-body">
         <label>설비명</label>
         <input type=text class="modaltext" id="ckfac-text">
        <button class="ckfacmodalbtn" type="button" id="ckfac">검색</button>
        
        <!-- 설비조회 그리드 -->
         <div id="grid2"></div>
         
        <button class="submitfacmodalbtn" type="button" data-dismiss="modal" onclick="getfac()">선택</button>
      </div>
    </div>
  </div>
</div> 

<hr>

 <!-- 그리드화면 -->
 <div id="grid"></div>
       
 
    <script>
    const token = $('meta[name="_csrf"]').attr("content");
    const header = $('meta[name="_csrf_header"]').attr("content");
    
    var dblclickRows=null;
    var getProcRows=null;
    var grid2 = null;
    var Progaddgrid = null;
   
    $(function(){  
      
    	
    	
		//설비코드버튼
		$('#facSelectmodalbtn').click(function(){
				
			$.ajax({
				url : "/fac/infoListAjax",
				method : "GET",
				dataType : "JSON",
				success : function(result){
					console.log(result)
					grid2.resetData(result);
					
					$('#chfacmodalbtn').modal('show');
					 $('#chfacmodalbtn').on('shown.bs.modal', function (e){
						 console.log('open');
						 setTimeout(()=> grid2.refreshLayout(), 100);
					 })	
				},error : function(reject){
					console.log(reject)
				}
			});
		})
    	
    	
          //점검목록리스트그리드
          $.ajax({
               url : "/fac/confirmListAjax",
               method : "GET",
               dataType : "JSON", //키:값 형식으로 가져온다.
               success : function(result){
                grid.resetData(result);
                grid.refreshLayout();
               }
               });
            
         var grid = new tui.Grid({
          el: document.getElementById('grid'),
          scrollX: false,
          scrollY: false,
          rowHeaders: ['rowNum'],
          columns: [
            {
              header: '점검코드',
              name: 'confirmCode'
            },
            {
              header: '설비명',
              name: 'facName'
            },
            {
              header: '점검구분',
              name: 'confirmCategory'
            },
            {
              header: '조치내역',
              name: 'actionHistory'
            },
            {
              header: '점검사항',
              name: 'confirmIssue'
            },
            {
                header: '판정',
                name: 'decision'
              },
            {
              header: '점검일자',
              name: 'confirmDate'
            },

            {
              header: '담당자',
              name: 'empNum'
            }   
          ]
         
        });
         
       
      //설비코드모달   
          grid2 = new tui.Grid({
          el: document.getElementById('grid2'),
          scrollX: false,
          scrollY: false,
          rowHeaders: ['rowNum','checkbox'],
          columns: [
            {
              header: '설비코드',
              name: 'facCode'
            },
            {
              header: '설비명',
              name: 'facName'
            }
          ]
         })
      
         //설비코드버튼
         $('#chfacmodalbtn').click(function(){
              
              $.ajax({
                     url : "/fac/infolistAjax",
                     method : "GET",
                     dataType : "JSON",
                     success : function(result){
                        console.log(result)
                        grid2.resetData(result);
   
                         $('#chfacmodalbtn').modal('show');
                         $('#chfacmodalbtn').on('shown.bs.modal', function (e) {
                            console.log('open');
                            setTimeout(()=> grid2.refreshLayout(), 100);   
                        })
                     },error : function(reject){
                        console.log(reject)
                     }
                  }); 
         })
      

         //공정코드모달검색조회
          $('#ckfac').on('click', function(){
             console.log($("#ckfac-text").val())
             const prsed = $("#ckfac-text").val()
            $("#ckfac-text").val('');
             
             $.ajax({
                 url : "/fac/facminilist",   //공정코드목록조회 페이지 
                  method : "GET",
                  data : {'result' : prsed},
                  success : function(result){
                     grid2.resetData(result);
                  },
                  error: function(reject){
                     console.log(reject)
                  }
        
          });
          
       })
       
       
       //외부 공정코드랑 공정명 input에 값을 뿌려주는 코드 
       grid2.on('click', function(e){
         let content = grid2.getRow(e.rowKey); //grid2의 이벤트가 걸린 로우키가 내용
         $('#fac_code').val(content.facCode); //fac_code라는 id의 인풋 창에 값 rowKey안의 facCode를 넣음
         $('#fac_name').val(content.facName);//fac_name라는 id의 인풋 창에 값 rowKey안의 facName을 넣음
      })      
       })
       
      
       
       
      //초기화버튼 이벤트
      $("#reset").on('click',function(){
         $('div input').not("input[name=operate_check]").val('');
      });
  
  
      //설비삭제버튼 이벤트
      $("#delete").on('click', function(){
         $.ajax({
            url: "/fac/facDelete", //컨트롤러에 연결된 주소
         method : "post", //조회는 항상 get, 나머진 post
         //json형태인 키:값 형태로 데이터넘김
         data: {
            facCode : $('#fac_code').val()
         },
          beforeSend: function (xhr) {
              xhr.setRequestHeader(header, token);
           },
           success: function (result){
            alert('삭제성공');
            $.ajax({
                  url : "/fac/infoListAjax",
                  method : "GET",
                  dataType : "JSON",
                  success : function(result){
                  grid.resetData(result);
                  grid.refreshLayout();
                  }
                  })
                  $('div input').not("input[name=confirm_issue]").val('');
         },
         error:function(reject){
            console.log(reject)
         }
         })

      });
      
    
    //설비수정버튼 이벤트
   $("#update").on('click',function(){

      $.ajax({
         url: "/fac/confirmUpdate", //컨트롤러에 연결된 주소
         method : "post", //조회는 항상 get, 나머진(수정,등록,삭제) post
         //json형태인 키:값 형태로 데이터넘김
         data: {
            facCode : $('#fac_code').val(),
               facName : $('#fac_name').val(),
               operateCheck :$('input[name=operate_check]:checked').val(),
               checkCycle : $('#check_cycle').val(),
               installDate : $("#install_date").val(),
               makerName : $('#maker_name').val(),
               tempMin : $('#temp_min').val(),
               tempMax : $('#temp_max').val(),
               empNum : $('#emp_num').val()
               },
            beforeSend: function (xhr) {
              xhr.setRequestHeader(header, token);
           },
      success: function (result){
         alert('수정성공');
         $.ajax({
               url : "/fac/infoListAjax",
               method : "GET",
               dataType : "JSON",
               success : function(result){
               grid.resetData(result);
               grid.refreshLayout();
               }
               })
               $('div input').not("input[name=operate_check]").val('');
            },
            error:function(reject){
            console.log(reject)
         }
      
      })
   });
         //설비등록버튼 이벤트
       $("#register").on('click',function(){
          console.log(Progaddgrid.getData());
          let insertProcData = Progaddgrid.getData();
          let facInsertData={};
          let innerData=[];
          insertProcData.forEach(function(ele){
             console.log(ele);
             console.log(ele.procCode);
              facInsertData = {
                       facCode : $("#fac_code").val(), 
                       facName : $("#fac_name").val(),
                      operateCheck : $("input[name=operate_check]:checked").val(),
                      checkCycle : $("#check_cycle").val(),
                      installDate : $("#install_date").val(),
                      makerName : $("#maker_name").val(),
                      tempMin : $("#temp_min").val(),
                      tempMax : $("#temp_max").val(),
                      empNum : $("#emp_num").val(),
                      procCode : ele.procCode
                      };
                    innerData.push(facInsertData)
          })
                
          facInsertData={"list":innerData};
           $.ajax({
             url: "/fac/facRegister", //컨트롤러에 연결된 주소
             method : "post", //조회는 항상 get, 나머진 post
             contentType : "application/json",
             //json형태인 키:값 형태로 데이터넘김
             data: JSON.stringify(facInsertData),
               beforeSend: function (xhr) {
                         xhr.setRequestHeader(header, token);
                        },
          success: function (result){
              $.ajax({
                   url : "/fac/infoListAjax",
                   method : "GET",
                   dataType : "JSON",
                   success : function(result){
                   grid.resetData(result);
                   grid.refreshLayout();
                   }
                   })
                   insertProcData.forEach(function(ele,i){
                      Progaddgrid.removeRow(ele.rowKey);
                   });
                   
                   $('div input').not("input[name=operate_check]").val('');
          },
          error:function(reject){
             console.log(reject)
          }
          
          })
       });
       
       //설비수정,삭제하기전 그리드 이벤트 작업
       //서버에 연결전 토큰값 담는 method
        grid.on("beforeRequest", function (obj) {
          obj.xhr.setRequestHeader(header, token);
        });
   
       grid.on("dblclick",function (e){
          console.log(grid.getRow(e.rowKey));
          dblclickRows=grid.getRow(e.rowKey); //클릭한 이벤트 row의 값을 담아줌

          console.log(dblclickRows);
          
          //값을 input창에 다시 담아줌
          $('#fac_code').val(dblclickRows.facCode);
          $('#fac_name').val(dblclickRows.facName);
          $('#check_cycle').val(dblclickRows.checkCycle);
          $('#install_date').val(dblclickRows.installDate);
          $('#emp_num').val(dblclickRows.empNum);
          $('#maker_name').val(dblclickRows.makerName);
          $('#temp_min').val(dblclickRows.tempMin);
          $('#temp_max').val(dblclickRows.tempMax);
          
          
       });
            
   

    function getProc(){
   getProcRows=grid2.getCheckedRows();
   console.log(getProcRows);
   Progaddgrid.appendRows(getProcRows);
   /* getProcRows.forEach(function(ele,i){
   Progaddgrid.appendRows(getProcRows[i])
   }); */
     $('#procmodalbtn').modal('hide'); 
      $('#procmodalbtn').hide();
      $('.bd-example-modal-lg').hide();
}
 </script>
   </div>
   </div>
</body>
</html>