<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/template}">
<head>
<meta charset="UTF-8">
<title>ordList</title>
<script src="https://kit.fontawesome.com/56e7c5522c.js"
	crossorigin="anonymous"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css">
<script
	src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<script
	src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script type="text/javascript" src="https://uicdn.toast.com/tui.pagination/v3.4.0/tui-pagination.js"></script>
<link rel="stylesheet" href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
<!-- <script src="https://code.jquery.com/jquery-1.11.3.js"></script> -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script src="/plugins/jquery/jquery.min.js"></script>
   <script src="/plugins/sweetalert2/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="/plugins/sweetalert2/sweetalert2.min.css" />

<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />


<style>
.modaltitle {
	text-align: center;
}

.modalbtn {
	text-align: center;
}

.process {
	display: inline;
}

.container-fluid {
	text-align: left !important;
}

.ordbtn {
	float: right;
	margin-bottom: 1px;
}

.ordbtn button {
	margin-right: 2px;
}

.ordReg {
	margin-top: 30px;
}

.form-control {
	width: 150px;
}
.modal-content{
text-align:center;
}
.formInput input.form-control{
display:inline-block;
}
</style>

</head>

<body>
	<div layout:fragment="title">
		<h1>주문서 관리</h1>
	</div>

	<div layout:fragment="content">
	<div class="row justify-content-end" style="margin:0 2px 8px 0;">
	<button style=" width:200px; height:40px;" type="button" class="btn btn-primary " data-toggle="modal" data-target=".bd-ordList-modal-lg">주문서 등록</button>
	<button style=" width:200px; height:40px; margin-left:10px;" id="BtnOrdCancle" class="btn btn btn-danger">주문서 취소</button>
	</div>
	<form id="searchform">
	<div class="formInput" style="border: 1px solid #aaa; padding : 20px; margin-bottom : 20px;">
     <div class="row">
     <label style="margin-left : 15px;">진행구분</label>
     <input style = "margin : 0 5px;" type="radio" id="allBtn" name="all" value="all" checked><label for="allBtn" style="margin-right:10px">전체</label> 
     <input style = "margin : 0 5px;" type="radio" id="ingBtn" name="all" value="ing"><label for="ingBtn" style="margin-right:10px">진행</label>
     <input style = "margin : 0 5px;" type="radio" id="finBtn" name="all" value="finish"><label for="finBtn" style="margin-right:10px">완료</label>
     </div>
		<div class="row" style="margin:10px 0">
		<div class="col-3">
			<label>거래처명</label> <input class="form-control" name="accName" type="text" id="accountlist-text"
				style="background-color: #e2e1e1;width:200px; display:inline-block;" readonly>
			<button  type="button" style="height:38px;margin-bottom:3px" id="accountList" class="fa-solid fa-magnifying-glass btn btn-primary"
				data-toggle="modal" data-target=".bd-account-modal-lg"></button>
		</div>
		<div class="col-3">
				<label>제품명</label> <input class="form-control" type="text" id="productlist-text"
				style="background-color: #e2e1e1; width:200px" name="prodName" readonly>
		 <button style="margin-right : 20px;height:38px;margin-bottom:3px" type="button" id="productList" class="fa-solid fa-magnifying-glass btn btn-primary" data-toggle="modal" data-target=".bd-product-modal-lg"></button>
		</div>
		<div class="col-3">
			<label>주문일자</label> <input style=" width:130px" class="form-control" name="ordDate1" type="date" id="orddate1-text"> - <input class="form-control" style="margin-right : 20px; width:130px;" name="ordDate2" type="date" id="orddate2-text"  min="" disabled >
		</div>		
		<div class="col-3">
			<label>납기일자</label> <input style=" width:130px" class="form-control" name="ordDueDate1" type="date" id="ordduedate1-text"> - <input class="form-control" style="margin-right : 20px; width:130px" name="ordDueDate2" type="date" id="ordduedate2-text" min="" disabled>
		</div>
		</div>
		<div style="margin-top:50px; "  class="row justify-content-center">
			<button type="button" id="searchOrd" class="btn btn-primary" style="margin-right:10px; width:74px;">조회</button>
			<button type="reset"  id="pageReset"  class="btn btn-primary">초기화</button>
		</div>		
	</div>
	</form>
		 
		


		<!------------------------------ 본문 모달 ------------------------------------->
		<!-- 거래처리스트 모달 -->
		<div class="modal fade bd-account-modal-lg" id="accountListModal"
			tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="p-3 modal-content">
			<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
						<h1 class="modaltitle"></h1>
					<p>
						<label >거래처명</label> <input type="text" id="searchacc-text">
						<button style="height:38px;" id="searchacc" type="submit" class="fa-solid fa-magnifying-glass btn btn-primary"></button>
					</p>
					<div id="accountGrid"></div>

					<div class="modalbtn ">
						<button class="btn btn-primary" id="searchacc-btn" data-toggle="modal"
							data-target=".bd-account-modal-lg">확인</button>
						<button class="btn btn-secondary" data-dismiss="modal">취소</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 거래처리스트 모달 끝 -->
		<!-- 제품 리스트 모달 -->
		<div class="modal fade bd-product-modal-lg" id="productListModal"
			tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="p-3 modal-content">
				<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
					<h1 class="modaltitle"></h1>
	
					<p>
						<label>제품명</label> <input id="searchprod-text" type="text">
						<button type="submit" id="searchprod"
							class="fa-solid fa-magnifying-glass btn btn-primary"></button>
					<div id="productGrid"></div>
					<div class="modalbtn">
						<button class = "btn btn-primary" id="modalsubmit" data-toggle="modal"
							data-target=".bd-product-modal-lg">확인</button>
						<button class="btn btn-secondary" data-dismiss="modal">취소</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 제품 리스트 모달 끝 -->

		<!------------------------------ 본문 모달끝 ------------------------------------->
		<!-- 본문 조회 그리드 -->
		<div id="grid"></div>
		<!--------------------------- 주문서등록 modal --------------------------------------->
		<div id="modalProdReg" class="modal fade bd-ordList-modal-lg"
			tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="p-3 modal-content">
					<div class="modal-header">
						<h1 class="modal-title">주문서 등록</h1>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<br>

					<div class="registerform">
						<div class="productReginput" style="display: flex;">
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">주문코드
								</label> <input type="text" id="modalOrdCode" class="form-control"
									name="ordCode" value="" readonly>
							</div>
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">담당자명
								</label> <input type="text" id="ordempname" class="form-control"
									name="empName" th:value="${#authentication.principal.empName}"
								readonly>
							</div>
							<input type="hidden" th:value="${userVO.empNum}" id="ordempnum"
								class="form-control" name="empCode" readonly>
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">거래처명</label>
									<button  type="button" class="fa-solid fa-magnifying-glass btn btn-primary"
										data-toggle="modal" data-target=".bd-smallaccount-modal-sm"></button>
								 <input id="ordaccname" type="text" class="form-control" name="accName" readonly>
							</div>
						</div>
						<div style="display: flex;">
							<div style="float: left; margin-right: 10px">
								<!-- <label for="recipient-name" class="col-form-label">거래처코드 </label> -->
								<input type="hidden" id="ordacccode" class="form-control"
									name="accCode" readonly>
							</div>
						</div>
						<div style="display: flex;">
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">주문일자
								</label> <input id="modalOrdDate" type="text" class="form-control"
									name="ordDate" readonly placeholder="현재날짜">
							</div>
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">납기일자
								</label> <input id="modalOrdDueDate" type="date" class="form-control"
									name="ordDueDate">
							</div>
						</div>

						<input type="hidden" id="modalOrdNote" class="form-control"
							name="ordNote"></input> <br>
						<hr>
						<br> 
						<label style="float:left;">제품리스트</label>
						<button style="float:left; "type="button" class="fa-solid fa-magnifying-glass btn btn-primary"
							data-toggle="modal" data-target=".bd-smallproduct-modal-sm"></button>
						<button class = "btn btn-danger" style="float: right; margin-right: 5px; margin-bottom : 5px;"id="ordProdDelete">삭제</button>
						<div id="addProdgrid"></div>
						<div class="modalbtn" style="margin-top : 5px;">
							<button id="ordregsubmit" type="submit" class="btn btn-primary">등록</button>
							<button type="button" class="btn btn-secondary"
								data-dismiss="modal" >취소</button>
						</div>
					</div>

					<!-- 주문서 등록내의 거래처리스트모달 -->
					<div class="modal fade bd-smallaccount-modal-sm"
						id="accountRegModal" tabindex="-1" role="dialog"
						aria-labelledby="mySmallModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-sm">
							<div class="p-3 modal-content">
							<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
								<h2 class="modaltitle"></h2>
								<p>
									거래처명 <input style="width:100px;"id="searchaccreg-text" type="text">
									<button id="searchaccreg" class="fa-solid fa-magnifying-glass btn btn-primary"></button>
								</p>
								<div id="accountRegGrid"></div>
								<div class="modalbtn">
									<button class = "btn btn-primary" id="modalregsubmit" data-toggle="modal"
										data-target=".bd-smallaccount-modal-sm">확인</button>
									<button class="btn btn-secondary" data-dismiss="modal">취소</button>
								</div>
							</div>
						</div>
					</div>
					<!-- 주문서 등록내의 거래처리스트모달 끝 -->

					<!-- 주문서 등록내의 제품리스트모달 -->
					<div class="modal fade bd-smallproduct-modal-sm"
						id="productRegModal" tabindex="-1" role="dialog"
						aria-labelledby="mySmallModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-sm">
							<div class="p-3 modal-content">
							<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
								<h2 class="modaltitle"></h2>
								<p>
									제품명 <input style="width:100px;" id="searchprodreg-text" type="text">
									<button id="searchprodreg" type="submit"
										class="fa-solid fa-magnifying-glass btn btn-primary"></button>
								</p>
								<div id="productRegGrid"></div>
								<div class="modalbtn">
									<button class = "btn btn-primary" id="modalsubmitbtn" data-toggle="modal"
										data-target=".bd-smallproduct-modal-sm" type="button">확인</button>
									<button class="btn btn-secondary" data-dismiss="modal">취소</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 주문서 등록내의 제품리스트 모달 끝 -->
		<!-- 주문서 등록 모달 끝 -->


		<!--------------------------- 주문서수정 modal --------------------------------------->
		<div id="modalProdMod" class="modal fade bd-ordList-modal-lg"
			tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="p-3 modal-content">
					<div class="modal-header">
						<h1 class="modal-title">주문 상세</h1>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<br>
					<div class="modal-body">
						<div class="registerform">
							<div class="productReginput" style="display: flex;">
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">주문코드
									</label> <input type="text" id="modalOrdModCode" class="form-control"
										name="ordCodeMod" value="" readonly>
								</div>
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">담당자명
									</label> <input type="text" id="ordempname" class="form-control"
										name="empName"
										th:value="${#authentication.principal.empName}" readonly>
								</div>

								<input type="hidden" th:value="${userVO.empNum}" id="ordempnum"
									class="form-control" name="empCode" readonly>

								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">거래처명

									</label> <input id="ordaccModname" type="text" class="form-control"
										name="accNameMod" readonly>
								</div>
							</div>
							<div style="display: flex;">
								<div style="float: left; margin-right: 10px">
									<!-- <label for="recipient-name" class="col-form-label">거래처코드 </label> -->
									<input type="hidden" id="ordaccModcode" class="form-control"
										name="accCodeMod" readonly>
								</div>
							</div>
							<div style="display: flex;">
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">주문일자
									</label> <input id="modalModOrdDate" type="text" class="form-control"
										name="ordDateMod" readonly placeholder="현재날짜">
								</div>
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">납기일자
									</label> <input id="modalModOrdDueDate" type="date"
										class="form-control" name="ordDueDateMod">
								</div>
							<div style="float: left; margin-right: 10px">
							<label for="recipient-name" class="col-form-label">비고
							</label> <input id="modalModOrdNote" class="form-control" name="ordNote">
							</div>
							</div>
							<br>
							<hr>
							<br> <label style="float:left;">제품리스트</label>
							<button id="modProdSearch" style="float:left;" type="button" class="fa-solid fa-magnifying-glass btn btn-primary"
								data-toggle="modal" data-target=".bd-smallproductMod-modal-sm"></button>
							<button class= "btn btn-danger" style="float: right; margin-right: 5px; margin-bottom:5px;"
								id="ordProdDelete2">삭제</button>
							<div id="modProdgrid"></div>
							<div style="margin-top: 5px;"class="modalbtn">
								<button id="ordmodsubmit" type="submit" class="btn btn-primary">수정</button>
								<button type="button" class="btn btn-secondary"
									data-dismiss="modal">취소</button>
							</div>
						</div>
					</div>
<!-- 주문서 수정 내의 제품리스트 모달 -->
					<div class="modal fade bd-smallproductMod-modal-sm"
						id="productModModal" tabindex="-1" role="dialog"
						aria-labelledby="mySmallModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-sm">
							<div class="p-1 modal-content">
							<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
								<h2 class="modaltitle">제품리스트</h2>
								<p>
									제품명 <input style="width:100px;" id="searchprodmod-text" type="text">
									<button id="searchprodmod" type="submit"
										class="fa-solid fa-magnifying-glass btn btn-primary"></button>
								</p>
								<div id="productRegGrid2"></div>
								<div class="modalbtn">
									<button class = "btn btn-primary" id="modalsubmitbtn2" data-toggle="modal"
										data-target=".bd-smallproductMod-modal-sm" type="button">확인</button>
									<button class="btn btn-secondary" data-dismiss="modal"> 취소</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 주문서 수정내의 제품리스트 모달 끝 -->
		<!-- 주문서 수정 모달 끝 -->

		<!--------------------------------------------------------- 스크립트 ------------------------------------------->
		<script>
		const token = $('meta[name="_csrf"]').attr("content");
		const header = $('meta[name="_csrf_header"]').attr("content");
		
		//제품모달창 엔터키
		$('#searchprod-text').on('keyup',function(e){
			 if(e.keyCode == 13){
				 $("#searchprod").click();
			 }
		})

		 //거래처엔터키
		 $('#searchacc-text').on('keyup',function(e){
			 if(e.keyCode == 13){
				 $("#searchacc").click();
			 }
		 })
		 //거래처엔터키
		 $('#searchaccreg-text').on('keyup',function(e){
			 if(e.keyCode == 13){
				 $("#searchaccreg").click();
			 }
		 })
		 //거래처엔터키
		 $('#searchprodreg-text').on('keyup',function(e){
			 if(e.keyCode == 13){
				 $("#searchprodreg").click();
			 }
		 })
		 //거래처엔터키
		 $('#searchprodmod-text').on('keyup',function(e){
			 if(e.keyCode == 13){
				 $("#searchprodmod").click();
			 }
		 })
		
		 //날짜 조건
		   var orddate1Input = document.getElementById("orddate1-text");
	       var orddate2Input = document.getElementById("orddate2-text");

	          orddate1Input.addEventListener("input", function() {
	            orddate2Input.min = orddate1Input.value;
	            orddate2Input.disabled = false;
	            
	          });
	          
	          var ordduedate1Input = document.getElementById("ordduedate1-text");
		       var ordduedate2Input = document.getElementById("ordduedate2-text");

		          ordduedate1Input.addEventListener("input", function() {
		            ordduedate2Input.min = ordduedate1Input.value;
		            ordduedate2Input.disabled = false;
		            
		          });
		
/* 		//초기화 버튼 클릭 시
		$('#pageReset').on('click',function(){
			
			$.ajax({
				url : "/bns/ordListAjax",
				method : "GET",
				dataType : "JSON",
				success : function(result){
					grid.resetData(result);
				}
			});
			
		}) */
		
		
		
		
		
		$('#ordProdDelete').on('click' ,function(){
			
			addProdgrid.removeCheckedRows(true)
			
		});
		
		
		
		   //주문서 등록모달 내 제품추가 그리드생성
		 var addProdgrid = new tui.Grid({
             el: document.getElementById('addProdgrid'),
             scrollX: false,
             scrollY: false,
             rowHeaders: [
                 {
                   type: 'rowNum'
                 },
                 {
                   type: 'checkbox'
                   
                 }	
               ],
             columns: [
            	
               {
                 header: '제품명',
                 name: 'prodName',
                 align : 'center'
               },
               {
                 header: '제품코드',
                 name: 'prodCode',
                 align : 'center'
               },
               {
                 header: '주문량',
                 name: 'ordDetQuan',
                 editor:'text',
                 align : 'center',
                 formatter({ value }) {
                     return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                   }

               },
               {
                   header: '단가',
                   name: 'ordDetPrice',
                   editor:'text',
                   align : 'center',
                   formatter({ value }) {
                       return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                     },

                 },
               {
                 header: '주문금액',
                 name: 'ordDetTotPrice',
                 align : 'center',
                 formatter({ value }) {
                     return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                   }

                 
               }
             ],
               summary: {
            	   height: 40,
            	    position: 'bottom',
             columnContent: {
            	 ordDetQuan: {
                   template: function(valueMap) {
                     return `TOT: ${valueMap.sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                   }
                 },
                 ordDetPrice: {
                   template: function(valueMap) {
                	   return `AVG: ${valueMap.avg.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                   }
                 },
                 ordDetTotPrice: {
                     template: function(valueMap) {
                       return `TOT: ${valueMap.sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                     }
                   }
               }
             }  
            	});
		   
		   //단가X주문량=주문금액 계산
          addProdgrid.on('editingFinish', function(ev){
       	  let row = addProdgrid.getRow(ev.rowKey);
       	  if((ev.columnName=="ordDetQuan" || ev.columnName=="ordDetPrice")&&row.ordDetQuan&&row.ordDetPrice){
       		  addProdgrid.setValue(ev.rowKey, "ordDetTotPrice", row.ordDetQuan*row.ordDetPrice, false)
       	  }
       	  
         }) 
         
              const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            timer: 1500,
            customClass: { container: "swalAlert" },
            showConfirmButton: false,
          });

         //주문서 등록 모달창의 등록 버튼클릭시
		$('#ordregsubmit').on('click' ,function(){
			addProdgrid.finishEditing();
			let checked = addProdgrid.getData();
			console.log(checked);
			checked.forEach(ele=>{
				ele.ordCode = $('#modalOrdCode').val();
				ele.empName = $('#ordempname').val();
				ele.empNum = $('#ordempnum').val();
				ele.accName = $('#ordaccname').val();
				ele.accCode = $('#ordacccode').val();
				ele.ordDate = $('#modalOrdDate').val();
				ele.ordDueDate = $('#modalOrdDueDate').val();
				ele.ordNote = $('#modalOrdNote').val();
			})
			console.log(checked)
			
			//등록아작스
			$.ajax({
			url : "/bns/insertOrdList",
			method : "POST",
			contentType : "application/json",
			data : JSON.stringify(checked),
			dataType : "JSON",
			beforeSend: function (xhr) {
	            xhr.setRequestHeader(header, token);
	          },
			success : function(result){
				
				 Toast.fire({
		                icon: "success", //success, error, warning, info, question
		                title: "주문서가 등록되었습니다.",
		                width: 400,
		              });
				
		        
		   		//전체 조회페이지 아작스
		   		$.ajax({
					url : "/bns/ordListAjax",
					method : "GET",
					dataType : "JSON",
					success : function(result){
						grid.resetData(result);
					}
				});
		        
				}
			});
			
		   	$('#modalProdReg').modal('hide');
			
		   	
			})
		
			
         //주문서 등록 모달창 띄웠을때 제품추가 그리드 뜨게
		$(function(){
		   	$('#modalProdReg').on('shown.bs.modal', function(){
		   		addProdgrid.refreshLayout();
		   	})
		   })

//주문코드 자동입력				
      $.ajax({
   		url : "/bns/ordCode",
   		method : "GET",
   		dataType : "JSON",
   		success : function(result){
   			console.log(result);
   			$('input[name=ordCode]').attr('value',result.ordCode);
   			$('input[name=ordDate]').attr('value',result.ordDate);
   		}
   	});


//등록 모달창 안 거래처리스트 
$.ajax({
		url : "/bns/accList",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			accountReg_Grid.resetData(result);
			accountReg_Grid.refreshLayout();
		}
	});
   var accountReg_Grid = new tui.Grid({
     el: document.getElementById('accountRegGrid'),
     scrollX: false,
     scrollY: false,
     rowHeaders: ['rowNum'],
     columns: [
       {
         header: '거래처코드',
         name: 'accCode',
         align : 'center'
       },
       {
         header: '거래처명',
         name: 'accName',
         align : 'center'
       }
   
     ]
   });
   //그리드 먼저 나타내고 모달창
   $(function(){
   	$('#accountRegModal').on('shown.bs.modal', function(){
   		accountReg_Grid.refreshLayout();
   	})
   })
       $("#searchaccreg").on('click', function(){
   	const result = $("#searchaccreg-text").val()
		$("#searchaccreg-text").val('');
   	
   	$.ajax({
   		 url : "/bns/accKeyList",
   	     method : "GET",
   	     data : {'result' : result},
   	     success : function(result){
   	     accountReg_Grid.resetData(result);
   	     accountReg_Grid.refreshLayout();
   	     },
   	     error: function(reject){
   	    	 console.log(reject)
   	     }
   });
   })
   accountReg_Grid.on('click', ev=> {
     
     const focusCell = accountReg_Grid.getFocusedCell()
    
     let dataRow = accountReg_Grid.getRow(ev.rowKey);
     
     $('#ordaccname').val(dataRow.accName);
     $('#ordacccode').val(dataRow.accCode);
     
     $('#modalregsubmit').click(function(){
   	  
   	  $.ajax({
 	 		url : "/bns/accList",
 	 		method : "GET",
 	 		dataType : "JSON",
 	 		success : function(result){
 	 			accountReg_Grid.resetData(result);
 	 			accountReg_Grid.refreshLayout();
 	 		}
 	 	});
   	  
   	  $('#accountRegModal').modal('hide');
     })
   })   
   
//등록 모달창 안 제품리스트
$.ajax({
		url : "/bns/prodList",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			productReg_Grid.resetData(result);
			productReg_Grid.refreshLayout();
			productReg_Grid2.resetData(result);
			productReg_Grid2.refreshLayout();

		}
	});
   
   var productReg_Grid = new tui.Grid({
     el: document.getElementById('productRegGrid'),
     scrollX: false,
     scrollY: false,
     rowHeaders: ['rowNum'],
     columns: [
       {
         header: '제품코드',
         name: 'prodCode',
         align : 'center'
       },
       {
         header: '제품명',
         name: 'prodName',
         align : 'center'
       }
     ]
   });
   
   var productReg_Grid2 = new tui.Grid({
	     el: document.getElementById('productRegGrid2'),
	     scrollX: false,
	     scrollY: false,
	     rowHeaders: ['rowNum'],
	     columns: [
	       {
	         header: '제품코드',
	         name: 'prodCode',
	         align : 'center'
	       },
	       {
	         header: '제품명',
	         name: 'prodName',
	         align : 'center'
	       }
	     ]
	   });
   
   $(function(){
   	$('#productRegModal').on('shown.bs.modal', function(){
   		productReg_Grid.refreshLayout();
   	})
   })
   
    $(function(){
   	$('#productModModal').on('shown.bs.modal', function(){
   		productReg_Grid2.refreshLayout();
   	})
   })
   
   
       $("#searchprodreg").on('click', function(){
   	const result = $("#searchprodreg-text").val()
		$("#searchprodreg-text").val('');
   	$.ajax({
   		 url : "/bns/prodKeyList",
   	     method : "GET",
   	     data : {'result' : result},
   	     success : function(result){
   	     productReg_Grid.resetData(result);
   	     productReg_Grid.refreshLayout();
   	  productReg_Grid2.resetData(result);
	     productReg_Grid2.refreshLayout();
   	     },
   	     error: function(reject){
   	    	 console.log(reject)
   	     }
 
   });
   })
   
   productReg_Grid.on('click', ev=> {
     const focusCell = productReg_Grid.getFocusedCell()

     let dataRow = productReg_Grid.getRow(ev.rowKey);
     delete dataRow.rowKey;
	
     dataRow.ordDetPrice = 0;
     dataRow.ordDetTotPrice = 0;
     dataRow.ordDetQuan = 0;
     
   	addProdgrid.appendRow(dataRow,{
 		  focus:true
 	  });
     $('#ordprodname').val(dataRow.prodName);
     $('#ordprodcode').val(dataRow.prodCode);
     
     $('#modalsubmitbtn').click(function(){
   
   	  $.ajax({
   	 		url : "/bns/prodList",
   	 		method : "GET",
   	 		dataType : "JSON",
   	 		success : function(result){
   	 			productReg_Grid.resetData(result);
   	 			productReg_Grid.refreshLayout();
   	 		}
   	 	});
   	  
   	  $('#productRegModal').modal('hide');
   	})
     })
     
      productReg_Grid2.on('click', ev=> {
    	  
    	  console.log(ev);
     let dataRow = productReg_Grid2.getRow(ev.rowKey);
	console.log(dataRow)
     delete dataRow.rowKey;
	 dataRow.ordDetPrice = 0;
     dataRow.ordDetTotPrice = 0;
     dataRow.ordDetQuan = 0;
   	modProdgrid.appendRow(dataRow,{
 		  focus:true
 	  });
     
     $('#modalsubmitbtn2').click(function(){
   
   	  $.ajax({
   	 		url : "/bns/prodList",
   	 		method : "GET",
   	 		dataType : "JSON",
   	 		success : function(result){
   	 			productReg_Grid2.resetData(result);
   	 			productReg_Grid2.refreshLayout();
   	 		}
   	 	});
   	  
   	  $('#productModModal').modal('hide');
   	})
     })



//거래처 리스트
$.ajax({
		url : "/bns/accList",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			account_Grid.resetData(result);
			account_Grid.refreshLayout();
		}
	});
   
 //본문 내 거래처리스트 그리드 생성
   var account_Grid = new tui.Grid({
     el: document.getElementById('accountGrid'),
     scrollX: false,
     scrollY: false,
     rowHeaders: ['rowNum'],
     columns: [
       {
         header: '거래처코드',
         name: 'accCode',
         align : 'center'
       },
       {
         header: '거래처명',
         name: 'accName',
         align : 'center'
       }
   
     ]
   });
   
 //본문 내 거래처 리스트 그리드 뜨고 모달창뜨게
   $(function(){
   	$('#accountListModal').on('shown.bs.modal', function(){
   		account_Grid.refreshLayout();
   	})
   })
   
   //본문 내 거래처 리스트 내 버튼클릭 시 
   $("#searchacc").on('click', function(){
   	const result = $("#searchacc-text").val()
		$("#searchacc-text").val('');
   	
   	
  //거래처 리스트 검색 아작스
   	$.ajax({
   		 url : "/bns/accKeyList",
   	     method : "GET",
   	     data : {'result' : result},
   	     success : function(result){
   	     account_Grid.resetData(result);
   	     account_Grid.refreshLayout();
   	     },
   	     error: function(reject){
   	    	 console.log(reject)
   	     }
 
   });
   })
   
   //거래처 리스트 그리드 클릭 시 
   account_Grid.on('click', ev=> {
    

     const focusCell = account_Grid.getFocusedCell()

     let dataRow = account_Grid.getRow(ev.rowKey);

     $('#accountlist-text').val(dataRow.accName);
     
     $("#searchacc-btn").click(function(){
   	  
   	  $.ajax({
   	 		url : "/bns/accList",
   	 		method : "GET",
   	 		dataType : "JSON",
   	 		success : function(result){
   	 			account_Grid.resetData(result);
   	 			account_Grid.refreshLayout();
   	 		}
   	 	});
   	 $('#accountListModal').modal('hide');

   	  
     })
   })   

//제품명 리스트
$.ajax({
		url : "/bns/prodList",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			product_Grid.resetData(result);
			product_Grid.refreshLayout();
		}
	});
 //제품명 모달창 생성
   var product_Grid = new tui.Grid({
     el: document.getElementById('productGrid'),
     scrollX: false,
     scrollY: false,
     rowHeaders: ['rowNum'],
     columns: [
       {
         header: '제품코드',
         name: 'prodCode',
         align : 'center'
       },
       {
         header: '제품명',
         name: 'prodName',
         align : 'center'
       }
   
     ]
   });
 //제품명 모달창 그리드 먼저 띄어주고 모달창 띄움
   $(function(){
   	$('#productListModal').on('shown.bs.modal', function(){
   		product_Grid.refreshLayout();
   	})
   })
   
   <!-- 제품조회검색 아작스 -->
   $("#searchprod").on('click', function(){
   	const result = $("#searchprod-text").val()
		$("#searchprod-text").val('');
   	
   	$.ajax({
   		 url : "/bns/prodKeyList",
   	     method : "GET",
   	     data : {'result' : result},
   	     success : function(result){
   	     product_Grid.resetData(result);
   	     product_Grid.refreshLayout();
   	     },
   	     error: function(reject){
   	    	 console.log(reject)
   	     }
 
   });
   })
   
   //모달창 내 제품그리드 클릭 시 본문의 input창으로 이동
       product_Grid.on('click', ev=> {
     console.log(ev.rowKey)
     console.log(ev.columns)

     const focusCell = product_Grid.getFocusedCell()
     console.log(focusCell)

     let dataRow = product_Grid.getRow(ev.rowKey);
     console.log(dataRow);

    
     $('#productlist-text').val(dataRow.prodName);
     
     $('#modalsubmit').click(function(){
   	  $('#productListModal').modal('hide');
   	  
   	  $.ajax({
    		 url : "/bns/prodList",
    	     method : "GET",
    	     dataType : "JSON",
    	     success : function(result){
    	     product_Grid.resetData(result);
    	     product_Grid.refreshLayout();
    	     }
    	     
  
    });
   	  
     })
   })  






//주문서 조건검색
$.ajax({
		url : "/bns/ordListAjax",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			grid.resetData(result);
		}
	});
	
	$("#searchOrd").on('click', function(){
	$.ajax({
		url : "/bns/ordListconAjax",
		method : "GET",
		data : $('#searchform').serialize(),
		dataType : "JSON",
		success : function(result){
			grid.resetData(result);
		}
	});
	})
	
	//본문 그리드 생성
   var grid = new tui.Grid({
	  
	   bodyHeight : 400,
     el: document.getElementById('grid'),
     scrollX: false,
     pageOptions: {
    	    useClient: true,	// front에서만 페이징 하는 속성
    	    perPage: 10
    	  },
     rowHeaders: [
         {
           type: 'rowNum'
         },
         {
           type: 'checkbox'
           
         }	
       ],
     columns: [
       {
         header: '주문코드',
         name: 'ordCode',
         align : 'center'
       },
       {
         header: '거래처코드',
         name: 'accCode',
         align : 'center'
       },
       {
         header: '거래처명',
         name: 'accName',
         sortable: true,
         filter: 'select',
         align : 'center'
       },
       {
         header: '주문일자',
         name: 'ordDate',
         sortable: true,
         align : 'center'
       },
       {
         header: '납기일자',
         name: 'ordDueDate',
         sortable: true,
         align : 'center'
       },
       {
           header: '담당자명',
           name: 'empName',
           align : 'center'
         },
       {
           header: '진행상황',
           name: 'ordProgress',
           filter: 'select',
           align : 'center'
         },
       {
           header: '비고',
           name: 'ordNote',
           align : 'center'
         }
   
     ]
    
   });
	
	
	
	
	
 	grid.on('dblclick', (ev) => {
	if(ev.columnName == 'ordCode'){
		$('#modalProdMod').modal('show');
		
		let row = grid.getRow(ev.rowKey)
		
		
		
		$('input[name=ordCodeMod]').attr('value',row.ordCode);
		$('input[name=accNameMod]').attr('value',row.accName);
		$('input[name=ordDateMod]').attr('value',row.ordDate);
		$('input[name=ordDueDateMod]').attr('value',row.ordDueDate);
		$('input[name=ordNote]').attr('value',row.ordNote);
	/* 	console.log(row.ordCode);
		console.log(row.accCode);
		console.log(row.accName);
		console.log(row.prodName);
		console.log(row.ordDate);
		console.log(row.ordDueDate);
		console.log(row.ordProgress);
		console.log(row.empName);
		console.log(row.ordNote); */
		
		$.ajax({
			url : "/bns/prodListModAjax",
			method : "GET",
			data : {result : row.ordCode},
			dataType : "JSON",
			success : function(result){
				modProdgrid.resetData(result);
				//버튼막기
				let modRow = modProdgrid.getData();
				console.log(modRow)
				modRow.forEach(ele=>{
					if(ele.ordDetProgress !== '접수완료'){
						modProdgrid.disableRow(ele.rowKey,true)
						
						let submitBtn = document.getElementById('ordmodsubmit');
						let deleteBtn = document.getElementById('ordProdDelete2');
						let dueDateBtn = document.getElementById('modalModOrdDueDate');
						let noteBtn = document.getElementById('modalModOrdNote');
						let searchBtn = document.getElementById('modProdSearch');
						
						submitBtn.disabled = true;
						deleteBtn.disabled = true;
						dueDateBtn.disabled = true;
						noteBtn.disabled = true;
						searchBtn.disabled = true;
						
					}else{
						let submitBtn = document.getElementById('ordmodsubmit');
						let deleteBtn = document.getElementById('ordProdDelete2');
						let dueDateBtn = document.getElementById('modalModOrdDueDate');
						let noteBtn = document.getElementById('modalModOrdNote');
						let searchBtn = document.getElementById('modProdSearch');
						
						submitBtn.disabled = false;
						deleteBtn.disabled = false;
						dueDateBtn.disabled = false;
						noteBtn.disabled = false;
						searchBtn.disabled = false;
						
					}
				})
				
			}
		});
	}
		})
 	
	
			//수정모달창의 제품그리드
		 var modProdgrid = new tui.Grid({
			 bodyHeight : 200,
             el: document.getElementById('modProdgrid'),
             scrollX: false,
             
             rowHeaders: [
                 {type: 'rowNum',},
                 { type: 'checkbox'}	
               			],
             columns: [
            	
               {
                 header: '제품명',
                 name: 'prodName',
                 align : 'center'
                 
               },
               {
                 header: '제품코드',
                 name: 'prodCode',
                 align : 'center'
               },
               {
                 header: '주문량',
                 name: 'ordDetQuan',
                 editor:'text',
                 align : 'center',
                 formatter({ value }) {
                     return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                   }
               },
               {
                   header: '단가',
                   name: 'ordDetPrice',
                   editor:'text',
                   align : 'center',
                   formatter({ value }) {
                       return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                     }
                 },
               {
                 header: '주문금액',
                 name: 'ordDetTotPrice',
                 align : 'center',
                 formatter({ value }) {
                     return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                   }
               },{
            	   header: '현황',
                   name: 'ordDetProgress',
                   align : 'center'
               }
                 ,
             ],
               summary: {
            	   height: 40,
            	    position: 'bottom',
             columnContent: {
            	 ordDetQuan: {
                   template: function(valueMap) {
                     return `TOT: ${valueMap.sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                   }
                 },
                 ordDetPrice: {
                   template: function(valueMap) {
                	   return `AVG: ${valueMap.avg.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                   }
                 },
                 ordDetTotPrice: {
                     template: function(valueMap) {
                       return `TOT: ${valueMap.sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                     }
                   }
               }
             }  
            	});
 	
	
 	
		 //총 주문금액 계산
          modProdgrid.on('editingFinish', function(ev){
       	  let row = modProdgrid.getRow(ev.rowKey);
       	  if((ev.columnName=="ordDetQuan" || ev.columnName=="ordDetPrice")&&row.ordDetQuan&&row.ordDetPrice){
       		  modProdgrid.setValue(ev.rowKey, "ordDetTotPrice", row.ordDetQuan*row.ordDetPrice, false)
       	  }
       	  
         }) 
         
         
         //주문수정 모달창의 삭제 버튼 눌렀을 때
         $('#ordProdDelete2').on('click',function(){
			modProdgrid.removeCheckedRows(true)
			let deleted = modProdgrid.getModifiedRows().deletedRows;
			
			console.log(deleted)
        	 
			if(deleted.length>0){
				
				$.ajax({
					url : "/bns/delOrdDetList",
					method : "POST",
					contentType : "application/json",
					data : JSON.stringify({list : deleted}),
					dataType : "JSON",
					beforeSend: function (xhr) {
			            xhr.setRequestHeader(header, token);
			          },
					success : function(result){
						
					}
					});
			}
        	 
        	 
         })
         
         //주문서 취소버튼 눌렀을 때
         $('#BtnOrdCancle').on('click',function(){
        	 let checked = grid.getCheckedRows()
        	 console.log(checked)
        		checked.forEach(ele=>{
				if(ele.ordProgress !== '접수완료'){
					 Toast.fire({
			                icon: "error", //success, error, warning, info, question
			                title: "취고할 수 업는 주문서입니다.",
			                width: 400,
			              });
					
				        			
        		}
        		else{
				
			grid.removeCheckedRows(true)
			let deleted = grid.getModifiedRows().deletedRows;
			console.log(deleted)
			if(deleted.length>0){
				$.ajax({
					url : "/bns/delOrdList",
					method : "POST",
					contentType : "application/json",
					data : JSON.stringify({ list : deleted}),
					dataType : "JSON",
					beforeSend: function (xhr) {
			            xhr.setRequestHeader(header, token);
			          },
					success : function(result){
						 Toast.fire({
				                icon: "success", //success, error, warning, info, question
				                title: "주문서가 취소되었습니다.",
				                width: 400,
				              });
						
					}
					});
			}
        		} 
        		})
         })
         
         
         
         
        
         //수정버튼 눌렀을 때
		$('#ordmodsubmit').on('click' ,function(){
			let checked = modProdgrid.getData();
			let modified = modProdgrid.getModifiedRows();
			console.log(modified)
			let none = modified.updatedRows.length+modified.createdRows.length+modified.deletedRows.length == 0;
			
			console.log(none)
			if(none){
				alert('수정된 항목이 없습니다.');
			}else{
			checked.forEach(ele=>{
				ele.ordCode = $('#modalOrdModCode').val();
				ele.empName = $('#ordempname').val();
				ele.empNum = $('#ordempnum').val();
				ele.accName = $('#ordaccname').val();
				ele.accCode = $('#ordacccode').val();
				ele.ordDate = $('#modalModOrdDate').val();
				ele.ordDueDate = $('#modalModOrdDueDate').val();
				ele.ordNote = $('#modalModOrdNote').val();
			})
			console.log(checked)
			
			$.ajax({
			url : "/bns/modOrdList",
			method : "POST",
			contentType : "application/json",
			data : JSON.stringify({ list : checked}),
			dataType : "JSON",
			beforeSend: function (xhr) {
	            xhr.setRequestHeader(header, token);
	          },
			success : function(result){
				 Toast.fire({
		                icon: "success", //success, error, warning, info, question
		                title: "주문서가 수정되었습니다.",
		                width: 400,
		              });
				
				
			}
			});
			
		   	$('#modalProdMod').modal('hide');
		   	
			}
			})
		
			
         //모달 띄우고 그리드 보여줄 때
		$(function(){
		   	$('#modalProdMod').on('shown.bs.modal', function(){
		   		modProdgrid.refreshLayout();
		   	})
		   })
	
		
		 
		 //그리드 한글로
		      tui.Grid.setLanguage("ko");
    </script>


	</div>
</body>
</html>