<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/template}">
<head>
<meta charset="UTF-8">
<title>contList</title>
<script src="https://kit.fontawesome.com/56e7c5522c.js"
	crossorigin="anonymous"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css">
<script
	src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<script
	src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script type="text/javascript" src="https://uicdn.toast.com/tui.pagination/v3.4.0/tui-pagination.js"></script>
<link rel="stylesheet" href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
<!-- <script src="https://code.jquery.com/jquery-1.11.3.js"></script> -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script src="/plugins/jquery/jquery.min.js"></script>
<script src="/plugins/sweetalert2/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="/plugins/sweetalert2/sweetalert2.min.css" />

<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />


<style>
.modaltitle {
	text-align: center;
}

.modalbtn {
	text-align: center;
}

.process {
	display: inline;
}

 .container-fluid {
	text-align: left !important;
} 

.contbtn {
	float: right;
	margin-bottom: 1px;
}

.contbtn button {
	margin-right: 2px;
}
.form-control {
	width: 150px;
}
.contReg {
	margin-top: 30px;
}

.form-control {
	width: 150px;
}
.modal-content{
text-align:center;
}
.formInput input.form-control{
display:inline-block;
}
</style>

</head>

<body>
	<div layout:fragment="title">
		<h1>계약서 관리</h1>
	</div>

	<div layout:fragment="content">
	<div class="row justify-content-end" style="margin:0 2px 8px 0;">
	<button style=" width:200px; height:40px;" type="button" class="btn btn-primary " data-toggle="modal" data-target=".bd-contList-modal-lg">계약서 등록</button>
	<button style=" width:200px; height:40px; margin-left:10px;" id="BtnContCancle" class="btn btn btn-danger">계약서 취소</button>
	</div>
		<form id="searchform">
     <div class="formInput" style="border: 1px solid #aaa; padding : 20px; margin-bottom : 20px;">
     <div class="row">
     <label style="margin-left : 15px;">진행구분</label>
     <input style = "margin : 0 5px;" type="radio" id="allBtn" name="all" value="all" checked><label for="allBtn" style="margin-right:10px">전체</label> 
     <input style = "margin : 0 5px;" type="radio" id="ingBtn" name="all" value="ing"><label for="ingBtn" style="margin-right:10px">진행</label>
     <input style = "margin : 0 5px;" type="radio" id="finBtn" name="all" value="finish"><label for="finBtn" style="margin-right:10px">완료</label>
     </div>
		<div class="row" style="margin:10px 0">
		<div class="col-3">
			<label>거래처명</label> <input class="form-control" name="accName" type="text" id="accountlist-text"
				style="background-color: #e2e1e1;width:200px" readonly>
			<button style="height:38px;margin-bottom:3px" type="button" id="accountList" class="fa-solid fa-magnifying-glass btn btn-primary"
				data-toggle="modal" data-target=".bd-account-modal-lg"></button>
		</div>
		<div class="col-3">
				<label>제품명</label> <input class="form-control" type="text" id="productlist-text"
				style="background-color: #e2e1e1; width:200px" name="prodName" readonly>
		 <button style="margin-right : 20px;height:38px;margin-bottom:3px" type="button" id="productList" class="fa-solid fa-magnifying-glass btn btn-primary" data-toggle="modal" data-target=".bd-product-modal-lg"></button>
		</div>
		<div class="col-3">
			<label>계약작성일자</label> <input style="width:124px" class="form-control" name="contDate1" type="date" id="contdate1-text"> - <input style="width:124px; margin-right : 20px; " class="form-control" name="contDate2" type="date" id="contdate2-text" min="" disabled>
		</div>		
		<div class="col-3">
			<label>계약만료일자</label> <input style="width:124px" class="form-control" name="contDueDate1" type="date" id="contduedate1-text"> - <input style="width:124px; margin-right : 20px;" class="form-control" name="contDueDate2" type="date" id="contduedate2-text" min="" disabled>
		</div>
		</div>
		<div style="margin-top:50px; " class="row justify-content-center">
			<button type="button" id="searchCont" class="btn btn-primary" style="margin-right:10px; width:74px;">조회</button>
			<button type="reset" id="pageReset" class="btn btn-primary">초기화</button>
		</div>	
		</div>
		</form>




		<!------------------------------ 본문 모달 ------------------------------------->
		<!-- 거래처리스트 모달 -->
		<div class="modal fade bd-account-modal-lg" id="accountListModal"
			tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="p-3 modal-content">
				<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
					<h1 class="modaltitle"></h1>
					<p>
						<label>거래처명</label> <input type="text" id="searchacc-text">
						<button id="searchacc" type="submit"
							class="fa-solid fa-magnifying-glass btn btn-primary"></button>
					<div id="accountGrid"></div>

					<div class="modalbtn">
						<button class="btn btn-primary" id="searchacc-btn" data-toggle="modal"
							data-target=".bd-account-modal-lg">확인</button>
						<button class="btn btn-secondary" data-dismiss="modal">취소</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 거래처리스트 모달 끝 -->
		<!-- 제품 리스트 모달 -->
		<div class="modal fade bd-product-modal-lg" id="productListModal"
			tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="p-3 modal-content">
				<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
					<h1 class="modaltitle"></h1>

					<p>
						<label>제품명</label> <input id="searchprod-text" type="text">
						<button type="submit" id="searchprod"
							class="fa-solid fa-magnifying-glass btn btn-primary"></button>
					<div id="productGrid"></div>
					<div class="modalbtn">
						<button class="btn btn-primary" id="modalsubmit" data-toggle="modal"
							data-target=".bd-product-modal-lg">확인</button>
						<button class="btn btn-secondary" data-dismiss="modal">취소</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 제품 리스트 모달 끝 -->

		<!------------------------------ 본문 모달끝 ------------------------------------->
		<!-- 본문 조회 그리드 -->
		<div id="grid"></div>
		<!--------------------------- 계약서등록 modal --------------------------------------->
		<div style="padding:20px;" id="modalProdReg" class="modal fade bd-contList-modal-lg"
			tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="p-3 modal-content">
					<div class="modal-header">
						<h1 class="modal-title">계약서 등록</h1>
						<button type="button" class="close btn btn-primary" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<br>

					<div class="registerform">
						<div class="productReginput" style="display: flex;">
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">계약코드
								</label> <input type="text" id="modalcontCode" class="form-control"
									name="contCode" value="" readonly>
							</div>
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">담당자명
								</label> <input type="text" id="contempname" class="form-control"
									name="empName" th:value="${#authentication.principal.empName}"
									readonly>
							</div>
							<input type="hidden" th:value="${userVO.empNum}" id="contempnum"
								class="form-control" name="empCode" readonly>
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">거래처명</label>
									<button type="button" class="fa-solid fa-magnifying-glass btn btn-primary"
										data-toggle="modal" data-target=".bd-smallaccount-modal-sm"></button>
								 <input id="contaccname" type="text" class="form-control"
									name="accName" readonly>
							</div>
						</div>
						<div style="display: flex;">
							<div style="float: left; margin-right: 10px">
								<!-- <label for="recipient-name" class="col-form-label">거래처코드 </label> -->
								<input type="hidden" id="contacccode" class="form-control"
									name="accCode" readonly>
							</div>
						</div>
						<div style="display: flex;">
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">계약작성일자
								</label> <input id="modalcontDate" type="text" class="form-control"
									name="contDate" readonly placeholder="현재날짜">
							</div>
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">계약시행일자
								</label> <input id="modalcontStartDate" type="date" class="form-control"
									name="contStartDate">
							</div>
							<div style="float: left; margin-right: 10px">
								<label for="recipient-name" class="col-form-label">계약만료일자
								</label> <input id="modalcontDueDate" type="date" class="form-control"
									name="contDueDate">
							</div>
						</div>

						<input type="hidden" id="modalcontNote" class="form-control"
							name="contNote"></input> <br>
						<hr>
						<br> 
						<div style="float:left;">
						<label>제품리스트</label>
						<button type="button" class="fa-solid fa-magnifying-glass btn btn-primary"
							data-toggle="modal" data-target=".bd-smallproduct-modal-sm"></button>
							</div>
						<button class="btn btn-danger" style="float: right; margin-right: 5px; margin-bottom:5px;"
							id="contProdDelete">삭제</button>
						<div id="addProdgrid"></div>
						<div style="margin-top : 5px;"class="modalbtn">
							<button id="contregsubmit" type="submit" class="btn btn-primary">등록</button>
							<button type="button" class="btn btn btn-secondary"
								data-dismiss="modal">취소</button>
						</div>
					</div>

					<!-- 계약서 등록내의 거래처리스트모달 -->
					<div class="modal fade bd-smallaccount-modal-sm"
						id="accountRegModal" tabindex="-1" role="dialog"
						aria-labelledby="mySmallModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-sm">
							<div class="p-1 modal-content">
							<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
								<h2 class="modaltitle"></h2>
								<p>
									거래처명 <input style="width:100px;"id="searchaccreg-text" type="text">
									<button id="searchaccreg" class="fa-solid fa-magnifying-glass btn btn-primary"></button>
								</p>
								<div id="accountRegGrid"></div>
								<div class="modalbtn">
									<button id="modalregsubmit" data-toggle="modal"
										data-target=".bd-smallaccount-modal-sm" class="btn btn-primary">확인</button>
									<button class="btn btn-secondary" data-dismiss="modal">취소</button>
								</div>
							</div>
						</div>
					</div>
					<!-- 계약서 등록내의 거래처리스트모달 끝 -->

					<!-- 계약서 등록내의 제품리스트모달 -->
					<div class="modal fade bd-smallproduct-modal-sm"
						id="productRegModal" tabindex="-1" role="dialog"
						aria-labelledby="mySmallModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-sm">
							<div class="p-1 modal-content">
							<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
								<h2 class="modaltitle"> </h2>
								<p>
						제품명 <input style="width:100px;" id="searchprodreg-text" type="text">
									<button id="searchprodreg" type="submit"
										class="fa-solid fa-magnifying-glass btn btn-primary"></button>
									
								</p>
								<div id="productRegGrid"></div>
								<div class="modalbtn">
									<button id="modalsubmitbtn" data-toggle="modal"
										data-target=".bd-smallproduct-modal-sm" type="button" class="btn btn-primary">확인</button>
									<button class="btn btn-secondary" data-dismiss="modal">취소</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 계약서 등록내의 제품리스트 모달 끝 -->
		<!-- 계약서 등록 모달 끝 -->


		<!--------------------------- 계약서수정 modal --------------------------------------->
		<div id="modalProdMod" class="modal fade bd-contList-modal-lg"
			tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="p-3 modal-content">
					<div class="modal-header">
						<h1 class="modal-title">계약 상세</h1>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<br>
					<div class="modal-body">
						<div class="registerform">
							<div class="productReginput" style="display: flex;">
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">계약코드
									</label> <input type="text" id="modalcontModCode" class="form-control"
										name="contCodeMod" value="" readonly>
								</div>
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">담당자명
									</label> <input type="text" id="contModempname" class="form-control"
										name="ModempName"
										th:value="${#authentication.principal.empName}" readonly>
								</div>

								<input type="hidden" th:value="${userVO.empNum}"
									id="contModempnum" class="form-control" name="ModempCode"
									readonly>

								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">거래처명

									</label> <input id="contaccModname" type="text" class="form-control"
										name="accNameMod" readonly>
								</div>
							</div>
							<div style="display: flex;">
								<div style="float: left; margin-right: 10px">
									<!-- <label for="recipient-name" class="col-form-label">거래처코드 </label> -->
									<input type="hidden" id="contaccModcode" class="form-control"
										name="accCodeMod" readonly>
								</div>
							</div>
							<div style="display: flex;">
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">계약작성일자
									</label> <input id="modalModcontDate" type="text" class="form-control"
										name="contDateMod" readonly placeholder="현재날짜">
								</div>
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">계약시행일자
									</label> <input id="modalModcontStartDate" type="date"
										class="form-control" name="contStartDateMod">
								</div>
								<div style="float: left; margin-right: 10px">
									<label for="recipient-name" class="col-form-label">계약만료일자
									</label> <input id="modalModcontDueDate" type="date"
										class="form-control" name="contDueDateMod">
								</div>
								<div style="float: left; margin-right: 10px">
							<label for="recipient-name" class="col-form-label">비고</label> <input
								id="modalModcontNote" class="form-control" name="contNoteMod"></input>
								</div>
							</div>
							<br>
							<hr>
							<br> <label style="float:left;">제품리스트</label>
							<button id="modProdSearch" style="float:left;" type="button" class="fa-solid fa-magnifying-glass btn btn-primary"
								data-toggle="modal" data-target=".bd-smallproductMod-modal-sm"></button>
							<button class = "btn btn-danger"style="float: right; margin-right: 5px; margin-bottom:5px;"
								id="contProdDelete2">삭제</button>
							<div id="modProdgrid"></div>
							<div style="margin-top : 5px;"class="modalbtn">
								<button id="contmodsubmit" type="submit" class="btn btn-primary">수정</button>
								<button type="button" class="btn btn-secondary"
									data-dismiss="modal">취소</button>
							</div>
						</div>
					</div>

					<div class="modal fade bd-smallproductMod-modal-sm"
						id="productModModal" tabindex="-1" role="dialog"
						aria-labelledby="mySmallModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-sm">
							<div class="p-3 modal-content">
							<div class="modal-header"> 
					<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
								<h2 class="modaltitle"></h2>
								<p>
									제품명 <input style="width:100px;"id="searchprodmod-text" type="text">
									<button id="searchprodmod" type="submit"
										class="fa-solid fa-magnifying-glass btn btn-primary"></button>
								</p>
								<div id="productRegGrid2"></div>
								<div class="modalbtn">
									<button class="btn btn-primary" id="modalsubmitbtn2" data-toggle="modal"
										data-target=".bd-smallproductMod-modal-sm" type="button">확인</button>
									<button class="btn btn-secondary" data-dismiss="modal" >취소</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 계약서 수정내의 제품리스트 모달 끝 -->
		<!-- 계약서 수정 모달 끝 -->


		<!--------------------------------------------------------- 스크립트 ------------------------------------------->
		<script>
		
	/* 	//초기화 버튼 클릭 시
		$('#pageReset').on('click',function(){
			
			$.ajax({
				url : "/bns/contListAjax",
				method : "GET",
				dataType : "JSON",
				success : function(result){
					grid.resetData(result);
				}
			});
			
		}) */
		
		
		
		const token = $('meta[name="_csrf"]').attr("content");
		const header = $('meta[name="_csrf_header"]').attr("content");
		
		//alert창
	    const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            timer: 1500,
            customClass: { container: "swalAlert" },
            showConfirmButton: false,
          });

		
		//제품모달창 엔터키
		$('#searchprod-text').on('keyup',function(e){
			 if(e.keyCode == 13){
				 $("#searchprod").click();
			 }
		})

		 //거래처엔터키
		 $('#searchacc-text').on('keyup',function(e){
			 if(e.keyCode == 13){
				 $("#searchacc").click();
			 }
		 })
		
		//날짜
		  var contdate1Input = document.getElementById("contdate1-text");
	       var contdate2Input = document.getElementById("contdate2-text");

	       contdate1Input.addEventListener("input", function() {
	    	   contdate2Input.min = contdate1Input.value;
	    	   contdate2Input.disabled = false;
	          });
	       
	       var contduedate1Input = document.getElementById("contduedate1-text");
	       var contduedate2Input = document.getElementById("contduedate2-text");

	       contduedate1Input.addEventListener("input", function() {
	    	   contduedate2Input.min = contduedate1Input.value;
	    	   contduedate2Input.disabled = false;
	          });
		
		$('#contProdDelete').on('click' ,function(){
			
			addProdgrid.removeCheckedRows(true)
			
		});
		
		
		
		   //계약서 등록모달 내 제품추가 그리드생성
		 var addProdgrid = new tui.Grid({
             el: document.getElementById('addProdgrid'),
             scrollX: false,
             scrollY: false,
             rowHeaders: [
                 {
                   type: 'rowNum'
                 },
                 {
                   type: 'checkbox'
                   
                 }	
               ],
             columns: [
            	
               {
                 header: '제품명',
                 name: 'prodName',
                 align : 'center'
               },
               {
                 header: '제품코드',
                 name: 'prodCode',
                 align : 'center'
               },
               {
                 header: '계약량',
                 name: 'contDetQuan',
                 editor:'text',
                 align : 'center',
                 formatter({ value }) {
                     return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                   },
               },
               {
                   header: '단가',
                   name: 'contDetPrice',
                   editor:'text',
                   align : 'center',
                   formatter({ value }) {
                       return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                     }
                 },
               {
                 header: '계약금액',
                 name: 'contDetTotPrice',
                 align : 'center',
                 formatter({ value }) {
                     return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                   }
               },
               {
                header: '납기일자',
                name: 'contDetRelease',
                editor:'datePicker',
                align : 'center'
              }
             ],
               summary: {
            	   height: 40,
            	    position: 'bottom',
             columnContent: {
            	 contDetQuan: {
                   template: function(valueMap) {
                     return `TOT: ${valueMap.sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                   }
                 },
                 contDetPrice: {
                   template: function(valueMap) {
                     return `AVR: ${valueMap.avg.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                   }
                 },
                 contDetTotPrice: {
                     template: function(valueMap) {
                       return `TOT: ${valueMap.sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                     }
                   }
               }
             }  
            	});
		   
		   //단가X계약량=계약금액 계산
          addProdgrid.on('editingFinish', function(ev){
       	  let row = addProdgrid.getRow(ev.rowKey);
       	  if((ev.columnName=="contDetQuan" || ev.columnName=="contDetPrice")&&row.contDetQuan&&row.contDetPrice){
       		  addProdgrid.setValue(ev.rowKey, "contDetTotPrice", row.contDetQuan*row.contDetPrice, false)
       	  }
       	  
         }) 
         
         
         //계약서 등록 모달창의 등록 버튼클릭시
		$('#contregsubmit').on('click' ,function(){
			addProdgrid.finishEditing();
			let checked = addProdgrid.getData();
			checked.forEach(ele=>{
				ele.contCode = $('#modalcontCode').val();
				ele.empName = $('#contempname').val();
				ele.empNum = $('#contempnum').val();
				ele.accName = $('#contaccname').val();
				ele.accCode = $('#contacccode').val();
				ele.contDate = $('#modalcontDate').val();
				ele.contStartDate = $('#modalcontStartDate').val();
				ele.contDueDate = $('#modalcontDueDate').val();
				ele.contNote = $('#modalcontNote').val();
			})
			console.log(checked)
			
			//등록아작스
			$.ajax({
			url : "/bns/insertcontList",
			method : "POST",
			contentType : "application/json",
			data : JSON.stringify({ list : checked}),
			dataType : "JSON",
			beforeSend: function (xhr) {
	            xhr.setRequestHeader(header, token);
	          },
			success : function(result){
				
				 Toast.fire({
		                icon: "success", //success, error, warning, info, question
		                title: "계약서가 등록되었습니다.",
		                width: 400,
		              });
				
		   		//전체 조회페이지 아작스
		   		$.ajax({
					url : "/bns/contListAjax",
					method : "GET",
					dataType : "JSON",
					success : function(result){
						grid.resetData(result);
					}
				});
		        
				}
			});
		   	$('#modalProdReg').modal('hide');
			})
		
			
         //계약서 등록 모달창 띄웠을때 제품추가 그리드 뜨게
		$(function(){
		   	$('#modalProdReg').on('shown.bs.modal', function(){
		   		addProdgrid.refreshLayout();
		   	})
		   })

//계약코드 자동입력				
      $.ajax({
   		url : "/bns/contCode",
   		method : "GET",
   		dataType : "JSON",
   		success : function(result){
   			console.log(result);
   			$('input[name=contCode]').attr('value',result[0].contCode);
   			$('input[name=contDate]').attr('value',result[0].contDate);
   		}
   	});


//등록 모달창 안 거래처리스트 
$.ajax({
		url : "/bns/accList",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			accountReg_Grid.resetData(result);
			accountReg_Grid.refreshLayout();
		}
	});
   var accountReg_Grid = new tui.Grid({
     el: document.getElementById('accountRegGrid'),
     scrollX: false,
     scrollY: false,
     rowHeaders: ['rowNum'],
     columns: [
       {
         header: '거래처코드',
         name: 'accCode',
         align : 'center'
       },
       {
         header: '거래처명',
         name: 'accName',
         align : 'center'
       }
   
     ]
   });
   //그리드 먼저 나타내고 모달창
   $(function(){
   	$('#accountRegModal').on('shown.bs.modal', function(){
   		accountReg_Grid.refreshLayout();
   	})
   })
       $("#searchaccreg").on('click', function(){
   	const result = $("#searchaccreg-text").val()
		$("#searchaccreg-text").val('');
   	
   	$.ajax({
   		 url : "/bns/accKeyList",
   	     method : "GET",
   	     data : {'result' : result},
   	     success : function(result){
   	     accountReg_Grid.resetData(result);
   	     accountReg_Grid.refreshLayout();
   	     },
   	     error: function(reject){
   	    	 console.log(reject)
   	     }
   });
   })
   accountReg_Grid.on('click', ev=> {
     
     const focusCell = accountReg_Grid.getFocusedCell()
    
     let dataRow = accountReg_Grid.getRow(ev.rowKey);
     
     $('#contaccname').val(dataRow.accName);
     $('#contacccode').val(dataRow.accCode);
     
     $('#modalregsubmit').click(function(){
   	  
   	  $.ajax({
 	 		url : "/bns/accList",
 	 		method : "GET",
 	 		dataType : "JSON",
 	 		success : function(result){
 	 			accountReg_Grid.resetData(result);
 	 			accountReg_Grid.refreshLayout();
 	 		}
 	 	});
   	  
   	  $('#accountRegModal').modal('hide');
     })
   })   
   
//등록 모달창 안 제품리스트
$.ajax({
		url : "/bns/prodList",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			productReg_Grid.resetData(result);
			productReg_Grid.refreshLayout();
			productReg_Grid2.resetData(result);
			productReg_Grid2.refreshLayout();

		}
	});
   
   var productReg_Grid = new tui.Grid({
     el: document.getElementById('productRegGrid'),
     scrollX: false,
     scrollY: false,
     rowHeaders: ['rowNum'],
     columns: [
       {
         header: '제품코드',
         name: 'prodCode',
         align : 'center'
       },
       {
         header: '제품명',
         name: 'prodName',
         align : 'center'
       }
     ]
   });
   
   var productReg_Grid2 = new tui.Grid({
	     el: document.getElementById('productRegGrid2'),
	     scrollX: false,
	     scrollY: false,
	     rowHeaders: ['rowNum'],
	     columns: [
	       {
	         header: '제품코드',
	         name: 'prodCode',
	         align : 'center'
	       },
	       {
	         header: '제품명',
	         name: 'prodName',
	         align : 'center'
	       }
	     ]
	   });
   
   $(function(){
   	$('#productRegModal').on('shown.bs.modal', function(){
   		productReg_Grid.refreshLayout();
   	})
   })
   
    $(function(){
   	$('#productModModal').on('shown.bs.modal', function(){
   		productReg_Grid2.refreshLayout();
   	})
   })
   
   
       $("#searchprodreg").on('click', function(){
   	const result = $("#searchprodreg-text").val()
		$("#searchprodreg-text").val('');
   	
   	
   	
   	$.ajax({
   		 url : "/bns/prodKeyList",
   	     method : "GET",
   	     data : {'result' : result},
   	     success : function(result){
   	     productReg_Grid.resetData(result);
   	     productReg_Grid.refreshLayout();
   	  productReg_Grid2.resetData(result);
	     productReg_Grid2.refreshLayout();
   	     },
   	     error: function(reject){
   	    	 console.log(reject)
   	     }
 
   });
   })
   
   productReg_Grid.on('click', ev=> {
     const focusCell = productReg_Grid.getFocusedCell()

     let dataRow = productReg_Grid.getRow(ev.rowKey);
     delete dataRow.rowKey;
     dataRow.contDetPrice = 0;
     dataRow.contDetTotPrice = 0;
     dataRow.contDetQuan = 0;

   	addProdgrid.appendRow(dataRow,{focus:true});
   	
     $('#contprodname').val(dataRow.prodName);
     $('#contprodcode').val(dataRow.prodCode);
     
     $('#modalsubmitbtn').click(function(){
   
   	  $.ajax({
   	 		url : "/bns/prodList",
   	 		method : "GET",
   	 		dataType : "JSON",
   	 		success : function(result){
   	 			productReg_Grid.resetData(result);
   	 			productReg_Grid.refreshLayout();
   	 		}
   	 	});
   	  
   	  $('#productRegModal').modal('hide');
   	})
     })
     
      productReg_Grid2.on('click', ev=> {
    	  console.log(ev);
     let dataRow = productReg_Grid2.getRow(ev.rowKey);
	console.log(dataRow)
     delete dataRow.rowKey;
	 dataRow.contDetPrice = 0;
     dataRow.contDetTotPrice = 0;
     dataRow.contDetQuan = 0;
   	modProdgrid.appendRow(dataRow,{
 		  focus:true
 	  });
     
     $('#modalsubmitbtn2').click(function(){
   
   	  $.ajax({
   	 		url : "/bns/prodList",
   	 		method : "GET",
   	 		dataType : "JSON",
   	 		success : function(result){
   	 			productReg_Grid2.resetData(result);
   	 			productReg_Grid2.refreshLayout();
   	 		}
   	 	});
   	  
   	  $('#productModModal').modal('hide');
   	})
     })



//거래처 리스트
$.ajax({
		url : "/bns/accList",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			account_Grid.resetData(result);
			account_Grid.refreshLayout();
		}
	});
   
 //본문 내 거래처리스트 그리드 생성
   var account_Grid = new tui.Grid({
     el: document.getElementById('accountGrid'),
     scrollX: false,
     scrollY: false,
     rowHeaders: ['rowNum'],
     columns: [
       {
         header: '거래처코드',
         name: 'accCode',
         align : 'center'
       },
       {
         header: '거래처명',
         name: 'accName',
         align : 'center'
       }
   
     ]
   });
   
 //본문 내 거래처 리스트 그리드 뜨고 모달창뜨게
   $(function(){
   	$('#accountListModal').on('shown.bs.modal', function(){
   		account_Grid.refreshLayout();
   	})
   })
   
   //본문 내 거래처 리스트 내 버튼클릭 시 
   $("#searchacc").on('click', function(){
   	const result = $("#searchacc-text").val()
		$("#searchacc-text").val('');
   	
   	
  //거래처 리스트 검색 아작스
   	$.ajax({
   		 url : "/bns/accKeyList",
   	     method : "GET",
   	     data : {'result' : result},
   	     success : function(result){
   	     account_Grid.resetData(result);
   	     account_Grid.refreshLayout();
   	     },
   	     error: function(reject){
   	    	 console.log(reject)
   	     }
 
   });
   })
   
   //거래처 리스트 그리드 클릭 시 
   account_Grid.on('click', ev=> {
    

     const focusCell = account_Grid.getFocusedCell()

     let dataRow = account_Grid.getRow(ev.rowKey);

     $('#accountlist-text').val(dataRow.accName);
     
     $("#searchacc-btn").click(function(){
   	  
   	  $.ajax({
   	 		url : "/bns/accList",
   	 		method : "GET",
   	 		dataType : "JSON",
   	 		success : function(result){
   	 			account_Grid.resetData(result);
   	 			account_Grid.refreshLayout();
   	 		}
   	 	});
   	 $('#accountListModal').modal('hide');

   	  
     })
   })   

//제품명 리스트
$.ajax({
		url : "/bns/prodList",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			product_Grid.resetData(result);
			product_Grid.refreshLayout();
		}
	});
   var product_Grid = new tui.Grid({
     el: document.getElementById('productGrid'),
     scrollX: false,
     scrollY: false,
     rowHeaders: ['rowNum'],
     columns: [
       {
         header: '제품코드',
         name: 'prodCode',
         align : 'center'
       },
       {
         header: '제품명',
         name: 'prodName',
         align : 'center'
       }
   
     ]
   });
   $(function(){
   	$('#productListModal').on('shown.bs.modal', function(){
   		product_Grid.refreshLayout();
   	})
   })
   
   // 제품조회검색 아작스 
   $("#searchprod").on('click', function(){
   	const result = $("#searchprod-text").val()
		$("#searchprod-text").val('');
   	
   	$.ajax({
   		 url : "/bns/prodKeyList",
   	     method : "GET",
   	     data : {'result' : result},
   	     success : function(result){
   	     product_Grid.resetData(result);
   	     product_Grid.refreshLayout();
   	     },
   	     error: function(reject){
   	    	 console.log(reject)
   	     }
 
   });
   })
   
       product_Grid.on('click', ev=> {
     console.log(ev.rowKey)
     console.log(ev.columns)

     const focusCell = product_Grid.getFocusedCell()
     console.log(focusCell)

     let dataRow = product_Grid.getRow(ev.rowKey);
     console.log(dataRow);

    
     $('#productlist-text').val(dataRow.prodName);
     
     $('#modalsubmit').click(function(){
   	  $('#productListModal').modal('hide');
   	  
   	  $.ajax({
    		 url : "/bns/prodList",
    	     method : "GET",
    	     dataType : "JSON",
    	     success : function(result){
    	     product_Grid.resetData(result);
    	     product_Grid.refreshLayout();
    	     }
    	     
  
    });
   	  
     })
   })  






//계약서 리스트뜨게
$.ajax({
		url : "/bns/contListAjax",
		method : "GET",
		dataType : "JSON",
		success : function(result){
			grid.resetData(result);
		}
	});
	
	
	$("#searchCont").on('click', function(){
		
	//조건검색 아작스	
	$.ajax({
		url : "/bns/contListconAjax",
		method : "GET",
		data : $('#searchform').serialize(),
		dataType : "JSON",
		success : function(result){
			grid.resetData(result);
		}
	});
	})
	
	//본문 그리드 생성
   var grid = new tui.Grid({
	   bodyHeight : 400,
     el: document.getElementById('grid'),
     scrollX: false,
     pageOptions: {
 	    useClient: true,	// front에서만 페이징 하는 속성
 	    perPage: 10
 	  },
     rowHeaders: [
         {
           type: 'rowNum'
         },
         {
           type: 'checkbox'
           
         }	
       ],
     columns: [
       {
         header: '계약코드',
         name: 'contCode',
         align : 'center'
       },
       {
         header: '거래처코드',
         name: 'accCode',
         align : 'center'
       },
       {
         header: '거래처명',
         name: 'accName',
         sortable: true,
         filter: 'select',
         align : 'center'
       },
       {
         header: '작성일자',
         name: 'contDate',
         sortable: true,
         align : 'center'
       },
       {
           header: '시행일자',
           name: 'contStartDate',
           sortable: true,
           align : 'center'
         },
       {
         header: '만료일자',
         name: 'contDueDate',
         sortable: true,
         align : 'center'
       },
       {
           header: '담당자명',
           name: 'empName',
           align : 'center'
         },
       {
           header: '진행상황',
           name: 'contProgress',
           filter: 'select',
           align : 'center'
         },
       {
           header: '비고',
           name: 'contNote',
           align : 'center'
         }
   
     ]
   });
	
	
	
	
	//계약상세화면 모달창 뜨게
 	grid.on('dblclick', (ev) => {
	if(ev.columnName == 'contCode'){
		$('#modalProdMod').modal('show');
		
		let row = grid.getRow(ev.rowKey)
		
		$('input[name=contCodeMod]').attr('value',row.contCode);
		$('input[name=accNameMod]').attr('value',row.accName);
		$('input[name=contDateMod]').attr('value',row.contDate);
		$('input[name=contStartDateMod]').attr('value',row.contStartDate);
		$('input[name=contDueDateMod]').attr('value',row.contDueDate);
		$('input[name=contNoteMod]').attr('value',row.contNote);
	/* 	console.log(row.contCode);
		console.log(row.accCode);
		console.log(row.accName);
		console.log(row.prodName);
		console.log(row.contDate);
		console.log(row.contDueDate);
		console.log(row.contDueDate);
		console.log(row.contNote); */
		
		console.log(row.empName);
		console.log(row.contStartDate);
		
		$.ajax({
			url : "/bns/contprodListModAjax",
			method : "GET",
			data : {result : row.contCode},
			dataType : "JSON",
			success : function(result){
				modProdgrid.resetData(result);
				//버튼막기
				let modRow = modProdgrid.getData();
				console.log(modRow)
				modRow.forEach(ele=>{
					ele.contProgress = row.contProgress
					if(ele.contProgress =='출고완료'){
						modProdgrid.disableRow(ele.rowKey,true)
						
						let submitBtn = document.getElementById('contmodsubmit');
						let deleteBtn = document.getElementById('contProdDelete2');
						let dueDateBtn = document.getElementById('modalModcontDueDate');
						let startDateBtn = document.getElementById('modalModcontStartDate');
						let noteBtn = document.getElementById('modalModcontNote');
						let searchBtn = document.getElementById('modProdSearch');
						
						submitBtn.disabled = true;
						deleteBtn.disabled = true;
						dueDateBtn.disabled = true;
						startDateBtn.disabled = true;
						noteBtn.disabled = true;
						searchBtn.disabled = true;
						
					}else{
						let submitBtn = document.getElementById('contmodsubmit');
						let deleteBtn = document.getElementById('contProdDelete2');
						let dueDateBtn = document.getElementById('modalModcontDueDate');
						let startDateBtn = document.getElementById('modalModcontStartDate');
						let noteBtn = document.getElementById('modalModcontNote');
						let searchBtn = document.getElementById('modProdSearch'); 
						
						submitBtn.disabled = false;
						deleteBtn.disabled = false;
						dueDateBtn.disabled = false;
						startDateBtn.disabled = false;
						noteBtn.disabled = false;
						searchBtn.disabled = false;
						
					}
			})
			}
		});
	}
		})
 	
	
			//수정모달창의 제품그리드
		 var modProdgrid = new tui.Grid({
			 bodyHeight : 200,
             el: document.getElementById('modProdgrid'),
             scrollX: false,
             
             rowHeaders: [
                 {type: 'rowNum',},
                 { type: 'checkbox'}	
               			],
             columns: [
            	 
               {
                 header: '제품명',
                 name: 'prodName',
                 align : 'center'
                 
               },
               {
                 header: '제품코드',
                 name: 'prodCode',
                 align : 'center'
               },
               {
                 header: '계약량',
                 name: 'contDetQuan',
                 editor:'text',
                 align : 'center',
                 formatter({ value }) {
                     return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                   }
               },
               {
                   header: '단가',
                   name: 'contDetPrice',
                   editor:'text',
                   align : 'center',
                   formatter({ value }) {
                       return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                     }
                 },
               {
                 header: '계약금액',
                 name: 'contDetTotPrice',
                 align : 'center',
                 formatter({ value }) {
                     return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                   }
               }
                 ,
                 {
                	 header: '납기일자',
                     name: 'contDetRelease',
                     editor:'datePicker',
                     align : 'center'
                     
                 }
                 ,
                 {
                	 header: '현황',
                     name: 'contDetProgress',
                     align : 'center'
                    
                 }
             ],
               summary: {
            	   height: 40,
            	    position: 'bottom',
             columnContent: {
            	 contDetQuan: {
                   template: function(valueMap) {
                	   return `TOT: ${valueMap.sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                   }
                 },
                 contDetPrice: {
                   template: function(valueMap) {
                	   return `AVR: ${valueMap.avg.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                   }
                 },
                 contDetTotPrice: {
                     template: function(valueMap) {
                    	 return `TOT: ${valueMap.sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                     }
                   }
               }
             }  
            	});
 	
 	
 	
 	
		 //총 계약금액 계산
          modProdgrid.on('editingFinish', function(ev){
       	  let row = modProdgrid.getRow(ev.rowKey);
       	  if((ev.columnName=="contDetQuan" || ev.columnName=="contDetPrice")&&row.contDetQuan&&row.contDetPrice){
       		  modProdgrid.setValue(ev.rowKey, "contDetTotPrice", row.contDetQuan*row.contDetPrice, false)
       	  }
       	  
         }) 
         
         
         //계약수정 모달창의 삭제 버튼 눌렀을 때
         $('#contProdDelete2').on('click',function(){
			modProdgrid.removeCheckedRows(true);
			let deleted = modProdgrid.getModifiedRows().deletedRows;
			
			console.log(deleted)
        	 
			if(deleted.length>0){
				
				$.ajax({
					url : "/bns/delContDetList",
					method : "POST",
					contentType : "application/json",
					data : JSON.stringify({ list : deleted}),
					dataType : "JSON",
					beforeSend: function (xhr) {
			            xhr.setRequestHeader(header, token);
			          },
					success : function(result){
						
						
					}
					});
			}
        	 
        	 
         })
         
   		//계약서 삭제
         $('#BtnContCancle').on('click',function(){
        	 
        	 let checked = grid.getCheckedRows()
        	 console.log(checked)
        		checked.forEach(ele=>{
				if(ele.contProgress !== '접수완료'){
					 Toast.fire({
			                icon: "error", //success, error, warning, info, question
			                title: "취소할 수 없는 계약서입니다.",
			                width: 400,
			              });
					
				}else{
        	 
			grid.removeCheckedRows(true)
			let deleted = grid.getModifiedRows().deletedRows;
			
			console.log(deleted)
        	 
			if(deleted.length>0){
				
				$.ajax({
					url : "/bns/delContList",
					method : "POST",
					contentType : "application/json",
					data : JSON.stringify({ list : deleted}),
					dataType : "JSON",
					beforeSend: function (xhr) {
			            xhr.setRequestHeader(header, token);
			          },
					success : function(result){
						 Toast.fire({
				                icon: "success", //success, error, warning, info, question
				                title: "계약서가 삭제되었습니다.",
				                width: 400,
				              });
					}
					});
			}
				}
        		})
        	 
         })
        
         //수정버튼 눌렀을 때
		$('#contmodsubmit').on('click' ,function(){
			let checked = modProdgrid.getData();
			let modified = modProdgrid.getModifiedRows();
			console.log(modified)
			let none = modified.updatedRows.length+modified.createdRows.length+modified.deletedRows.length == 0;
			
			console.log(none)
			if(none){
				alert('수정된 항목이 없습니다.');
			}else{
			checked.forEach(ele=>{
				ele.contCode = $('#modalcontModCode').val();
				ele.empName = $('#contModempname').val();
				ele.empNum = $('#contModempnum').val();
				ele.accName = $('#contaccModname').val();
				ele.accCode = $('#contaccModcode').val();
				ele.contDate = $('#modalModcontDate').val();
				ele.contStartDate = $('#modalModcontStartDate').val();
				ele.contDueDate = $('#modalModcontDueDate').val();
				ele.contNote = $('#modalModcontNote').val();
			})
			console.log(checked)
			
			$.ajax({
			url : "/bns/modContList",
			method : "POST",
			contentType : "application/json",
			data : JSON.stringify({list : checked}),
			dataType : "JSON",
			beforeSend: function (xhr) {
	            xhr.setRequestHeader(header, token);
	          },
			success : function(result){
				 Toast.fire({
		                icon: "success", //success, error, warning, info, question
		                title: "계약서가 수정되었습니다.",
		                width: 400,
		              });
				
			}
			});
			
		   	$('#modalProdMod').modal('hide');
		   	
			}
			})
		
			
         //모달 띄우고 그리드 보여줄 때
		$(function(){
		   	$('#modalProdMod').on('shown.bs.modal', function(){
		   		modProdgrid.refreshLayout();
		   	})
		   })
		  
		
		
		/* console.log(ev)
	      const focusCell = grid.getFocusedCell()
	      console.log(focusCell)

	      let dataRow = grid.getRow(ev.rowKey);
	      console.log(dataRow); */
	      
	      //그리드 한글로
	      tui.Grid.setLanguage("ko");
	
    </script>


	</div>
</body>
</html>